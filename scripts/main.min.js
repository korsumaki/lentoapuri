var log="Ohjelmakoodi p\u00e4iv\u00e4tty: 2016-02-02<br>",VfrRepArray,CurrentAerodromeArray,OfficialAerodromeArray,ZZZZFieldArray,gPosition_lat,gPosition_lon,flightPlanLink,gCalculatedFlyingTimeStr,gSelectedFlyingTimeStr,airspaceData,VFRPortFilename="",AerodromesFilename="",ZZZZFieldsFilename="",AirspaceFilename="",CANVAS_WIDTH=300,CANVAS_HEIGHT=300,DATA_VALIDITY_JSON_FILE="data/validity.json",MAX_CANVAS_SIZE=800,MIN_CANVAS_SIZE=300,SCREEN_MARGINAL=20,UNOFFICIAL_AERODROME="ZZZZ",UNOFFICIAL_AERODROME_INDEX=
0,BY_PHONE_ON_GROUND_STR="PHONE ACC ",BY_PHONE_ON_GROUND_STR_WITH_PHONE="PHONE ACC 032865172 ",BY_RTF_ON_AIR_STR="RTF ACC ",BY_TWR="- (torni)",NOTE_TO_ADD_ACC_FREQ_STR="LIS\u00c4\u00c4_ACC_JAKSO",PYROTECHNICS_NOTE_REMARKS="rakettipelastusvarjo",OPENAVIATIONDATA_APIKEY="mkXQV7UpiiBgOVjxbTzioYfpOlNVtEtg",overrideFlightTime=!0,mapCacheRouteArray,total_startup_start_time=0,aerodromeXml_start_time=0;function debug_log(a){log+=a+"<br>";document.getElementById("log").innerHTML=log}
function debug_timestamp_start(a){return(new Date).getTime()}function debug_timestamp_ready(a,b){(new Date).getTime()}function getFlightTimeOverride(){return overrideFlightTime}
function setFlightTimeOverride(a){if(overrideFlightTime!=a)if(overrideFlightTime=a,1==overrideFlightTime)$("#overrideFlightTimeContainer").slideDown();else{$("#overrideFlightTimeContainer").slideUp();var b=document.getElementsByName("flightTimeHour");for(a=0;a<b.length;a++)$("#flightTime"+b[a].value+"h").removeAttr("checked").checkboxradio("refresh");b=document.getElementsByName("flightTimeMin");for(a=0;a<b.length;a++)$("#flightTime"+b[a].value).removeAttr("checked").checkboxradio("refresh");gSelectedFlyingTimeStr=
gCalculatedFlyingTimeStr}}function onFlightTimeOverrideButton(){setFlightTimeOverride(!getFlightTimeOverride())}function isEverythingReady(){var a=!0;void 0==VfrRepArray&&(a=!1);void 0==OfficialAerodromeArray&&(a=!1);void 0==ZZZZFieldArray&&(a=!1);return a}
function continueIfEverythingIsReady(){debug_timestamp_ready("total startup (check if everything is ready)",total_startup_start_time);isEverythingReady()&&(PopulateSelections(),onChangeDepartureAd(),onChangeDestinationAd());debug_timestamp_ready("total startup (all but position)",total_startup_start_time);void 0!==OfficialAerodromeArray&&void 0!==ZZZZFieldArray&&void 0!==gPosition_lat&&handlePositionUpdate(gPosition_lat,gPosition_lon)}
function handlePositionError(a){document.getElementById("locationUpdateButtonText").innerHTML="Ei sijaintia";$("#location-button").removeClass("location-waiting").addClass("location-not-available");switch(a.code){case a.PERMISSION_DENIED:debug_log("Sijainti ei ole saatavilla (PERMISSION_DENIED)");break;case a.POSITION_UNAVAILABLE:debug_log("Sijainti ei ole saatavilla (POSITION_UNAVAILABLE)");break;case a.TIMEOUT:debug_log("Sijainti ei ole saatavilla (TIMEOUT)");break;default:debug_log("Sijainti ei ole saatavilla (unknown error)")}fakeCurrentLocation()}
function handlePositionUpdateCallback(a){debug_timestamp_ready("total startup (got position update)",total_startup_start_time);handlePositionUpdate(a.coords.latitude,a.coords.longitude);a=1E3>a.coords.accuracy?"("+Math.round(a.coords.accuracy)+"m)":"("+Math.round(a.coords.accuracy/1E3)+"km)";document.getElementById("locationUpdateButtonText").innerHTML="Sijainti "+a;$("#location-button").removeClass("location-waiting location-not-available")}
function handlePositionUpdate(a,b){gPosition_lat=a;gPosition_lon=b;if(void 0!==OfficialAerodromeArray&&void 0!==ZZZZFieldArray){"enabled"==document.getElementById("zzzzFieldsEnabled").value?(debug_log("Kaikki lentokent\u00e4t k\u00e4yt\u00f6ss\u00e4."),CurrentAerodromeArray=OfficialAerodromeArray.concat(ZZZZFieldArray)):(debug_log("Vain viralliset lentokent\u00e4t k\u00e4yt\u00f6ss\u00e4."),CurrentAerodromeArray=OfficialAerodromeArray);0<CurrentAerodromeArray.length&&CurrentAerodromeArray[0].icao===
UNOFFICIAL_AERODROME&&(CurrentAerodromeArray[0].lat=a,CurrentAerodromeArray[0].lon=b,CurrentAerodromeArray[0].latStr=DMS_to_DM(Decimal_to_DMS_lat(a)),CurrentAerodromeArray[0].lonStr=DMS_to_DM(Decimal_to_DMS_lon(b)));for(var c=1;c<CurrentAerodromeArray.length;++c)CurrentAerodromeArray[c].calcDistanceFrom(a,b);CurrentAerodromeArray.sort(waypointDistanceSort);debug_log("Nykyinen sijainti "+Math.round(CurrentAerodromeArray[1].distance)+" km kent\u00e4lt\u00e4 "+CurrentAerodromeArray[1].name+", "+CurrentAerodromeArray[1].icao);
PopulateSelections();onChangeDepartureAd();onChangeDestinationAd();debug_timestamp_ready("total startup (after position update)",total_startup_start_time)}}function addPrefixDigits(a,b,c){for(;a.length<c;)a=b+a;return a}
function DMS_to_DM(a){var b=0,c=0,d=0,e=a.substr(a.length-1,1).toUpperCase();7==a.length?(b=parseInt(a.substr(0,2),10),c=parseInt(a.substr(2,2),10),d=parseInt(a.substr(4,2),10)):8==a.length?(b=parseInt(a.substr(0,3),10),c=parseInt(a.substr(3,2),10),d=parseInt(a.substr(5,2),10)):debug_log("ERROR: DMS_to_DM(): DMS coordinate does not look valid! dms="+a);30<=d&&(c+=1);60==c&&(c=0,b+=1);switch(e){case "N":case "S":return addPrefixDigits(b.toString(),"0",2)+addPrefixDigits(c.toString(),"0",2)+e;case "W":case "E":return addPrefixDigits(b.toString(),
"0",3)+addPrefixDigits(c.toString(),"0",2)+e;default:debug_log("ERROR: DMS_to_DM(): DMS coordinate does not look valid! No letter at the end (or wrong letter). dms="+a)}}
function DMS_to_Decimal(a){var b=1,c=0,d=0,e=0;switch(a.substr(a.length-1,1).toUpperCase()){case "N":case "E":a=a.substr(0,a.length-1);break;case "S":case "W":b=-1;a=a.substr(0,a.length-1);break;default:debug_log("ERROR: DMS_to_Decimal(): DMS coordinate does not look valid! No letter at the end (or wrong letter). dms="+a)}6==a.length?(c=parseInt(a.substr(0,2),10),d=parseInt(a.substr(2,2),10),e=parseInt(a.substr(4,2),10)):7==a.length?(c=parseInt(a.substr(0,3),10),d=parseInt(a.substr(3,2),10),e=parseInt(a.substr(5,
2),10)):debug_log("ERROR: DMS_to_Decimal(): DMS coordinate does not look valid! dms="+a);return b*(c+(60*d+e)/3600)}function Decimal_to_DMS_lat(a){var b,c,d="N";0>a&&(d="S",a=-a);b=parseInt(a);a=60*(a-b);c=parseInt(a);a-=c;a*=60;a=Math.round(a);60==a&&(a=0,c+=1);60==c&&(c=0,b+=1);return addPrefixDigits(b.toString(),"0",2)+addPrefixDigits(c.toString(),"0",2)+addPrefixDigits(a.toString(),"0",2)+d}
function Decimal_to_DMS_lon(a){var b,c,d="E";0>a&&(d="W",a=-a);b=parseInt(a);a=60*(a-b);c=parseInt(a);a-=c;a*=60;a=Math.round(a);60==a&&(a=0,c+=1);60==c&&(c=0,b+=1);return addPrefixDigits(b.toString(),"0",3)+addPrefixDigits(c.toString(),"0",2)+addPrefixDigits(a.toString(),"0",2)+d}function Waypoint(a,b,c){this.name=a;this.lat=b;this.lon=c;this.distance=0}function toRad(a){return Math.PI/180*a}function toDeg(a){return a/(Math.PI/180)}
function calcDistanceFrom(a,b,c,d){var e=toRad(c-a);b=toRad(d-b);a=toRad(a);c=toRad(c);a=Math.sin(e/2)*Math.sin(e/2)+Math.sin(b/2)*Math.sin(b/2)*Math.cos(a)*Math.cos(c);return 12742*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))}Waypoint.prototype.getDistance=function(){return this.distance};Waypoint.prototype.calcDistanceFrom=function(a,b){this.distance=calcDistanceFrom(this.lat,this.lon,a,b)};Aerodrome.prototype=new Waypoint;Aerodrome.prototype.constructor=Aerodrome;
function Aerodrome(a,b,c,d,e,f,g){Waypoint.call(this,a,DMS_to_Decimal(c),DMS_to_Decimal(d));this.latStr=DMS_to_DM(c);this.lonStr=DMS_to_DM(d);this.icao=b;this.atc=e;this.acc=f;this.vfrPoints=g}function waypointDistanceSort(a,b){return a.distance-b.distance}function vfrPortXmlResponseHandler(){if(this.readyState==this.DONE||4==this.readyState)200==this.status&&null!==this.responseXML?vfrPortReadyHandler(this.responseXML):debug_log("ERROR: vfrPortXmlResponseHandler - error: status="+this.status)}
function aerodromeXmlResponseHandler(){if(this.readyState==this.DONE||4==this.readyState)200==this.status&&null!==this.responseXML?(debug_timestamp_ready("aerodromeXml loaded",aerodromeXml_start_time),aerodromeReadyHandler(this.responseXML)):debug_log("ERROR: aerodromeXmlResponseHandler - error: status="+this.status)}
function zzzzFieldXmlResponseHandler(){if(this.readyState==this.DONE||4==this.readyState)200==this.status&&null!==this.responseXML?zzzzFieldReadyHandler(this.responseXML):debug_log("ERROR: zzzzFieldXmlResponseHandler - error: status="+this.status)}function loadXMLDoc(a,b){var c;window.XMLHttpRequest?c=new XMLHttpRequest:(c=new ActiveXObject("Microsoft.XMLHTTP"),debug_log("going IE way"));c.onreadystatechange=b;c.open("GET",a,!0);c.send()}
function vfrPortReadyHandler(a){var b=debug_timestamp_start("vfrPortReadyHandler");try{var c=a.getElementsByTagName("metadata");if(0<c.length){var d=c[0].getElementsByTagName("time")[0].childNodes[0].nodeValue,e=new Date(d);debug_log("VFR ilmoittautumispisteet p\u00e4iv\u00e4tty: "+e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate())}}catch(g){debug_log("Could not read xml date: "+g)}a=a.getElementsByTagName("wpt");VfrRepArray=[];for(c=0;c<a.length;++c)if(d=a[c].getElementsByTagName("name")[0].childNodes[0].nodeValue,
"Compulsory"==a[c].getElementsByTagName("desc")[0].childNodes[0].nodeValue){var e=a[c].attributes.getNamedItem("lat").value,f=a[c].attributes.getNamedItem("lon").value;VfrRepArray.push(new Waypoint(d,e,f))}debug_log("=> "+VfrRepArray.length+" VFR ilmoittautumispistett\u00e4.");debug_timestamp_ready("vfrPortReadyHandler",b);loadXMLDoc(ZZZZFieldsFilename,zzzzFieldXmlResponseHandler)}
function aerodromeReadyHandler(a){var b=debug_timestamp_start("aerodromeReadyHandler");try{var c=a.getElementsByTagName("gpx");0<c.length&&debug_log("Lentokentt\u00e4tiedot p\u00e4iv\u00e4tty: "+c[0].attributes.getNamedItem("created").value)}catch(n){debug_log("Could not read xml date: "+n)}try{var d=a.getElementsByTagName("aerodrome");OfficialAerodromeArray=[];OfficialAerodromeArray.push(new Aerodrome("Ep\u00e4virallinen",UNOFFICIAL_AERODROME,"000000N","0000000E","no",NOTE_TO_ADD_ACC_FREQ_STR,[]));
for(a=0;a<d.length;++a){for(var e=d[a].getElementsByTagName("name")[0].childNodes[0].nodeValue,f=d[a].getElementsByTagName("icao")[0].childNodes[0].nodeValue,g=d[a].getElementsByTagName("atc")[0].childNodes[0].nodeValue,h=d[a].getElementsByTagName("acc")[0].childNodes[0].nodeValue.replace("."," "),k=d[a].attributes.getNamedItem("lat").value,m=d[a].attributes.getNamedItem("lon").value,l=d[a].getElementsByTagName("vfrpoint"),c=[],p=0;p<l.length;++p)c.push(l[p].childNodes[0].nodeValue);OfficialAerodromeArray.push(new Aerodrome(e,
f,k,m,g,h,c))}}catch(n){alert(n)}debug_log("=> "+OfficialAerodromeArray.length+" lentokentt\u00e4\u00e4.");debug_timestamp_ready("aerodromeReadyHandler",b);loadXMLDoc(VFRPortFilename,vfrPortXmlResponseHandler)}
function zzzzFieldReadyHandler(a){var b=debug_timestamp_start("zzzzFieldReadyHandler");try{var c=a.getElementsByTagName("gpx");0<c.length&&debug_log("Ep\u00e4virallisten lentopaikkojen tiedot p\u00e4iv\u00e4tty: "+c[0].attributes.getNamedItem("created").value)}catch(l){debug_log("Could not read xml date: "+l)}try{var d=a.getElementsByTagName("aerodrome");ZZZZFieldArray=[];for(a=0;a<d.length;++a){var e=d[a].getElementsByTagName("name")[0].childNodes[0].nodeValue,f=d[a].getElementsByTagName("icao")[0].childNodes[0].nodeValue,
g=d[a].getElementsByTagName("atc")[0].childNodes[0].nodeValue,h=d[a].getElementsByTagName("acc")[0].childNodes[0].nodeValue.replace("."," "),k=d[a].attributes.getNamedItem("lat").value,m=d[a].attributes.getNamedItem("lon").value;d[a].getElementsByTagName("vfrpoint");ZZZZFieldArray.push(new Aerodrome(e,f,k,m,g,h,[]))}}catch(l){alert(l)}debug_log("=> "+ZZZZFieldArray.length+" ep\u00e4virallista lentopaikkaa.");debug_timestamp_ready("zzzzFieldReadyHandler",b);continueIfEverythingIsReady()}
function removeOptions(a){for(;0<a.length;)a.remove(0)}function appendOption(a,b,c){var d=document.createElement("option");d.text=b;d.value=c;try{a.add(d,null)}catch(e){a.add(d)}}
function getAerodromeByIndex(a){return void 0===CurrentAerodromeArray?(debug_log("NOTE: getAerodromeByIndex(): CurrentAerodromeArray not yet loaded"),null):a>=CurrentAerodromeArray.length?(debug_log("ERROR: getAerodromeByIndex(): index "+a+" too big. CurrentAerodromeArray.length="+CurrentAerodromeArray.length),null):CurrentAerodromeArray[a]}
function getVfrWayPointByName(a){if(void 0===VfrRepArray)return null;for(var b=0;b<VfrRepArray.length;++b)if(a==VfrRepArray[b].name)return VfrRepArray[b];return null}function getVfrWayPointsByName(a){for(var b=[],c=0;c<a.length;++c){var d=getVfrWayPointByName(a[c]);null!==d&&b.push(d)}return b}
function PopulateSelections(){var a=document.getElementById("departure"),b=document.getElementById("destination");removeOptions(a);removeOptions(b);void 0===CurrentAerodromeArray&&(CurrentAerodromeArray=OfficialAerodromeArray);var c=999,d="";switch(document.getElementById("aircraftSpeedUnit").value){case "K":c=1;d="km";break;case "N":c=1/1.852,d="NM"}for(var e=0;e<CurrentAerodromeArray.length;++e){var f=CurrentAerodromeArray[e].icao+" ("+CurrentAerodromeArray[e].name;0!==Math.round(CurrentAerodromeArray[e].distance)&&
(f+=", "+Math.round(CurrentAerodromeArray[e].distance*c)+" "+d);f+=")";appendOption(a,f,e);appendOption(b,f,e)}a.selectedIndex=1;b.selectedIndex=1}
function onChangeFlightLv(){var a=document.getElementById("flight_level");a.value="";switch(document.getElementById("flight_lv").value){case "F":case "A":a.setAttribute("maxlength",3);$("#flight_level_container").slideDown();break;case "S":case "M":a.setAttribute("maxlength",4);$("#flight_level_container").slideDown();break;case "VFR":$("#flight_level_container").slideUp()}}
function onChangeFlightLevel(){var a=document.getElementById("flight_level").value;switch(document.getElementById("flight_lv").value){case "F":case "A":document.getElementById("flight_level").value=addPrefixDigits(a,"0",3);break;case "S":case "M":document.getElementById("flight_level").value=addPrefixDigits(a,"0",4)}}
function clearAircraftSettingsFields(){document.getElementById("aircraftIdentification").value="";document.getElementById("aircraftType").value="";document.getElementById("equipment").value="";document.getElementById("equipmentPBN").value="";document.getElementById("ssr").value="C";document.getElementById("aircraftSpeedUnit").value="K";document.getElementById("aircraftSpeed").value="";document.getElementById("aircraftColor").value="";document.getElementById("pyrotechnicsOnBoard").value="off";$("#ssr").selectmenu("refresh");
$("#aircraftSpeedUnit").selectmenu("refresh")}
function updateAircraftSelectionList(){var a=localStorage.getItem("aircraftSettingsTable");if(null==a)debug_log("ERROR: updateAircraftSelectionList() - table is null");else{var a=a.split(","),b=document.getElementById("aircraftSettingsList");removeOptions(b);for(var c=localStorage.getItem("currentSettingsId"),d=0,e=0;e<a.length;++e){var f=a[e];f==c&&(d=e);var g=localStorage.getItem(f+"_aircraftIdentification");null==g&&(g="Nimet\u00f6n");appendOption(b,g,f)}appendOption(b,"Lis\u00e4\u00e4 kone","NewAircraft");
b.selectedIndex=d;try{$("#aircraftSettingsList").selectmenu("refresh")}catch(h){}}}function onChangeAircraftSettings(){var a=document.getElementById("aircraftSettingsList").value;clearAircraftSettingsFields();"NewAircraft"==a?(addNewAircraftSettings(),$("#pyrotechnicsOnBoard").flipswitch("refresh")):(localStorage.setItem("currentSettingsId",a),updateFromLocalStorage(),onChangeAircraftSpeed());updateAircraftIdentificationToMainpage()}
function removeAircraftDataWithPrefix(a){localStorage.removeItem(a+"aircraftIdentification");localStorage.removeItem(a+"aircraftType");localStorage.removeItem(a+"equipment");localStorage.removeItem(a+"equipmentPBN");localStorage.removeItem(a+"ssr");localStorage.removeItem(a+"aircraftSpeedUnit");localStorage.removeItem(a+"aircraftSpeed");localStorage.removeItem(a+"aircraftColor");localStorage.removeItem(a+"pyrotechnicsOnBoard")}
function deleteCurrentAircraftSettings(){var a=localStorage.getItem("currentSettingsId"),b=localStorage.getItem("aircraftSettingsTable");if(null==b)debug_log("ERROR: deleteCurrentAircraftSettings() - table == null");else{var b=b.split(","),c=0;1<b.length&&(c=b.indexOf(a),b.splice(c,1),0<c&&c--,localStorage.setItem("aircraftSettingsTable",b));removeAircraftDataWithPrefix(a+"_");a=b[c];localStorage.setItem("currentSettingsId",a);updateAircraftSelectionList();onChangeAircraftSettings()}}
function addNewAircraftSettings(){var a=localStorage.getItem("aircraftSettingsTable");if(null==a)debug_log("ERROR: addNewAircraftSettings() - table == null");else{var a=a.split(","),b=0;0<a.length&&(b=+a[a.length-1]+1);a.push(b);localStorage.setItem("aircraftSettingsTable",a);localStorage.setItem("currentSettingsId",b)}}
function updateAircraftIdentificationToMainpage(){var a=document.getElementById("aircraftIdentification").value;0!==a.length?document.getElementById("selectedPlane").innerHTML="Kone: "+a:document.getElementById("selectedPlane").innerHTML=""}
function onChangeAircraftIdentification(){var a=localStorage.getItem("currentSettingsId");localStorage.setItem(a+"_aircraftIdentification",document.getElementById("aircraftIdentification").value);updateAircraftSelectionList();updateAircraftIdentificationToMainpage()}function onChangeAircraftType(){var a=localStorage.getItem("currentSettingsId");localStorage.setItem(a+"_aircraftType",document.getElementById("aircraftType").value)}
function isPbnNeeded(){var a=document.getElementById("equipment").value;return-1!==a.indexOf("R")||-1!==a.indexOf("r")?!0:!1}function onChangeEquipment(){var a=localStorage.getItem("currentSettingsId"),b=document.getElementById("equipment").value;localStorage.setItem(a+"_equipment",b);onChangeSsr();isPbnNeeded()?$("#equipment_PBN_container").slideDown():(document.getElementById("equipmentPBN").value="",onChangeEquipmentPBN(),$("#equipment_PBN_container").slideUp())}
function onChangeSsr(){var a=localStorage.getItem("currentSettingsId");localStorage.setItem(a+"_ssr",document.getElementById("ssr").value)}function onChangeEquipmentPBN(){var a=localStorage.getItem("currentSettingsId");localStorage.setItem(a+"_equipmentPBN",document.getElementById("equipmentPBN").value)}
function onChangeAircraftSpeed(){var a=document.getElementById("aircraftSpeed").value,a=addPrefixDigits(a,"0",4);document.getElementById("aircraftSpeed").value=a;var b=localStorage.getItem("currentSettingsId");localStorage.setItem(b+"_aircraftSpeedUnit",document.getElementById("aircraftSpeedUnit").value);localStorage.setItem(b+"_aircraftSpeed",a);PopulateSelections();onChangeDepartureAd();onChangeDestinationAd()}
function onChangePilot(){localStorage.setItem("pilot",document.getElementById("pilot").value)}function onChangePilotTel(){localStorage.setItem("pilotTel",document.getElementById("pilotTel").value)}function onChangeAircraftColor(){var a=localStorage.getItem("currentSettingsId");localStorage.setItem(a+"_aircraftColor",document.getElementById("aircraftColor").value)}
function onChangePyrotechnicsOnBoard(){var a=localStorage.getItem("currentSettingsId");localStorage.setItem(a+"_pyrotechnicsOnBoard",document.getElementById("pyrotechnicsOnBoard").value)}function onChangeZzzzFieldsEnabled(){localStorage.setItem("zzzzFieldsEnabled",document.getElementById("zzzzFieldsEnabled").value);handlePositionUpdate(gPosition_lat,gPosition_lon)}
function convertOldSettings(){localStorage.setItem("aircraftSettingsTable",[0]);localStorage.setItem("currentSettingsId",0);var a=localStorage.getItem("aircraftIdentification");null!==a&&localStorage.setItem("0_aircraftIdentification",a);a=localStorage.getItem("aircraftType");null!==a&&localStorage.setItem("0_aircraftType",a);a=localStorage.getItem("equipment");null!==a&&localStorage.setItem("0_equipment",a);a=localStorage.getItem("ssr");null!==a&&localStorage.setItem("0_ssr",a);a=localStorage.getItem("aircraftSpeedUnit");
null!==a&&localStorage.setItem("0_aircraftSpeedUnit",a);a=localStorage.getItem("aircraftSpeed");null!==a&&localStorage.setItem("0_aircraftSpeed",a);a=localStorage.getItem("aircraftColor");null!==a&&localStorage.setItem("0_aircraftColor",a);removeAircraftDataWithPrefix("")}
function updateFromLocalStorage(){var a=localStorage.getItem("currentSettingsId");null==a&&(convertOldSettings(),a=localStorage.getItem("currentSettingsId"));var b=localStorage.getItem(a+"_aircraftIdentification");null!==b&&(document.getElementById("aircraftIdentification").value=b);b=localStorage.getItem(a+"_aircraftType");null!==b&&(document.getElementById("aircraftType").value=b);b=localStorage.getItem(a+"_equipment");null===b&&(b="V",localStorage.setItem(a+"_equipment",b));null!==b&&(document.getElementById("equipment").value=
b);b=localStorage.getItem(a+"_ssr");if(null!==b){document.getElementById("ssr").value=b;try{$("#ssr").selectmenu("refresh")}catch(c){}}isPbnNeeded()?$("#equipment_PBN_container").slideDown():$("#equipment_PBN_container").slideUp();document.getElementById("equipmentPBN").value="";b=localStorage.getItem(a+"_equipmentPBN");null!==b&&(document.getElementById("equipmentPBN").value=b);b=localStorage.getItem(a+"_aircraftSpeedUnit");if(null!==b){document.getElementById("aircraftSpeedUnit").value=b;try{$("#aircraftSpeedUnit").selectmenu("refresh")}catch(c){}}b=
localStorage.getItem(a+"_aircraftSpeed");null!==b&&(document.getElementById("aircraftSpeed").value=b);b=localStorage.getItem("pilot");null!==b&&(document.getElementById("pilot").value=b);b=localStorage.getItem("pilotTel");null!==b&&(document.getElementById("pilotTel").value=b);b=localStorage.getItem(a+"_aircraftColor");null!==b&&(document.getElementById("aircraftColor").value=b);a=localStorage.getItem(a+"_pyrotechnicsOnBoard");null===a&&(a="off");document.getElementById("pyrotechnicsOnBoard").value=
a;try{$("#pyrotechnicsOnBoard").flipswitch("refresh")}catch(c){}a=localStorage.getItem("zzzzFieldsEnabled");null!==a&&(document.getElementById("zzzzFieldsEnabled").value=a);updateAircraftSelectionList()}function isValid(a){return void 0===a||0>=a.length?!1:!0}
function isAllSettingsAvailable(){try{var a=document.getElementById("aircraftIdentification").value,b=document.getElementById("aircraftType").value,c=document.getElementById("equipment").value,d="ok";isPbnNeeded()&&(d=document.getElementById("equipmentPBN").value);var e=document.getElementById("ssr").value,f=document.getElementById("aircraftSpeedUnit").value,g=document.getElementById("aircraftSpeed").value,h=document.getElementById("pilot").value,k=document.getElementById("pilotTel").value,m=document.getElementById("aircraftColor").value;
return void 0===gCalculatedFlyingTimeStr?!1:isValid(a)&&isValid(b)&&isValid(c)&&isValid(e)&&isValid(d)&&isValid(f)&&isValid(g)&&isValid(h)&&isValid(k)&&isValid(m)?!0:!1}catch(l){return!1}}function getPlansFromStorage(){var a=localStorage.getItem("storedPlans");return null==a?[]:JSON.parse(a)}function addPlanToStorage(a){var b=getPlansFromStorage();b.push(a);localStorage.setItem("storedPlans",JSON.stringify(b))}
function deleteCurrentStoredPlan(){var a=getPlansFromStorage(),b=localStorage.getItem("selectedStoredPlanIndex");a.splice(b,1);localStorage.setItem("storedPlans",JSON.stringify(a));updateStoredPlanList()}function removeOldPlansFromStorage(){var a=getPlansFromStorage(),b=[],c=new Date;c.setTime((new Date).getTime()-864E5);for(var d=0;d<a.length;d++)new Date(a[d].takeoff_time)>=c&&b.push(a[d]);localStorage.setItem("storedPlans",JSON.stringify(b))}
function getTimeIn4digits(a){var b="",c=a.getHours();a=a.getMinutes();10>c&&(b+="0");b+=c;10>a&&(b+="0");return b+a}function setSelectedStoredPlanIndex(a){localStorage.setItem("selectedStoredPlanIndex",a)}
function updateStoredPlanList(){removeOldPlansFromStorage();var a=getPlansFromStorage();$("#storedPlanList").find("li").remove();localStorage.removeItem("selectedStoredPlanIndex");for(var b=0;b<a.length;b++){var c=getTimeIn4digits(new Date(a[b].takeoff_time)),d="";void 0!==a[b].dep_route&&(d+=a[b].dep_route+" ");void 0!==a[b].route&&(d+=a[b].route+" ");void 0!==a[b].dest_route&&(d+=a[b].dest_route);c="<li class='storedPlanListItem'><a href='#page-stored-plan' onClick='setSelectedStoredPlanIndex("+
b+")'><h2>"+a[b].departure+"-"+a[b].destination+"</h2><p class='ui-li-aside'>L\u00e4ht\u00f6aika:<br><strong>"+c+"</strong> (sa)</p><p><strong>Reitti: "+d+"</strong></p><p>Lentoaika: "+a[b].flight_time+"</p><p>P\u00e4\u00e4tt\u00e4minen: "+a[b].completion_method+"</p></a>";a[b].destination!==UNOFFICIAL_AERODROME&&(c+="<a href='"+getNotamLink(a[b].destination)+"' rel='external'>Notam</a>");c+="</li>";$("#storedPlanList").append($(c))}$(".buttonContainer").hide();$("#storedPlanList").listview("refresh")}
function initStoredPlanPageHandler(){$("#page-stored-plan").on("pagebeforeshow",function(a){a=getPlansFromStorage();var b=localStorage.getItem("selectedStoredPlanIndex");$("#storedPlanAircraftIdentification").val(a[b].identification);$("#storedPlanDeparture").val(a[b].departure+" "+a[b].dep_name);$("#storedPlanDestination").val(a[b].destination+" "+a[b].dest_name);$("#storedPlanRoute").val(a[b].dep_route+" "+a[b].route+" "+a[b].dest_route);$("#storedPlanFlightLevel").val(a[b].flight_level);$("#storedPlanTakeoffTime").val(getTimeIn4digits(new Date(a[b].takeoff_time))+
" (sa)");$("#storedPlanFlightTime").val(a[b].flight_time);$("#storedPlanEndurance").val(a[b].endurance);$("#storedPlanPersons").val(a[b].persons);$("#storedPlanDepMethod").val(a[b].activation_method);$("#storedPlanArrMethod").val(a[b].completion_method);a[b].activation_method!==BY_PHONE_ON_GROUND_STR_WITH_PHONE&&a[b].completion_method!==BY_PHONE_ON_GROUND_STR_WITH_PHONE?$("#callAccButton").hide():$("#callAccButton").show()})}
function showOFPContainer(){$("#OFPContainer").slideDown();$("#OFPContainerToggleButton").text("Piilota...")}function hideOFPContainer(){$("#OFPContainer").slideUp();$("#OFPContainerToggleButton").text("N\u00e4yt\u00e4...")}function onOFPContainerToggleClick(){$("#OFPContainer").is(":hidden")?showOFPContainer():hideOFPContainer()}
function loadValidityJson(){$.getJSON(DATA_VALIDITY_JSON_FILE,function(a,b,c){b=new Date;for(c=0;c<a.data.length;++c){var d=new Date(a.data[c].validFrom);b.getTime()>=d.getTime()&&(AerodromesFilename=a.data[c].aerodromes,ZZZZFieldsFilename=a.data[c].zzzzfields,VFRPortFilename=a.data[c].vfrpoints,AirspaceFilename=a.data[c].airspace)}""==AerodromesFilename&&""==ZZZZFieldsFilename&&""==VFRPortFilename&&alert("En l\u00f6yd\u00e4 kentt\u00e4tietoja t\u00e4lle p\u00e4iv\u00e4m\u00e4\u00e4r\u00e4lle (en muista kovin vanhoja juttuja). Tarkista laitteesi p\u00e4iv\u00e4m\u00e4\u00e4r\u00e4asetus.")}).fail(function(){alert("Virhe validity.json tiedoston lataamisessa. Tiedostoa ei l\u00f6ydy tai formaatti on pieless\u00e4. Kokeile ladata sivu uudestaan. Jos vika ei poistu, ota yhteytt\u00e4 Lentosuunnitelma-apurin tekij\u00e4\u00e4n.")}).always(function(){onStartup()})}
function loadAirspaceJson(){$.getJSON(AirspaceFilename,function(a,b,c){airspaceData=a}).fail(function(){alert("Virhe airspace.json tiedoston lataamisessa. Tiedostoa ei l\u00f6ydy tai formaatti on pieless\u00e4. Kokeile ladata sivu uudestaan. Jos vika ei poistu, ota yhteytt\u00e4 Lentosuunnitelma-apurin tekij\u00e4\u00e4n.")}).always(function(){})}function onLoad(){window.addEventListener("resize",resizeCanvas,!1);loadValidityJson();resizeCanvas()}
function onStartup(){loadAirspaceJson();total_startup_start_time=debug_timestamp_start("onStartup");aerodromeXml_start_time=debug_timestamp_start("aerodromeXml load start");loadXMLDoc(AerodromesFilename,aerodromeXmlResponseHandler);navigator.geolocation?updateCurrentLocation():(debug_log("Geolocation ei ole tuettu selaimessa."),fakeCurrentLocation(),document.getElementById("locationUpdateButtonText").innerHTML="Ei sijaintia",$("#location-button").removeClass("location-waiting").addClass("location-not-available"));
updateFromLocalStorage();onChangeFlightLv();updateStoredPlanList();initStoredPlanPageHandler();hideOFPContainer()}function fakeCurrentLocation(){debug_log("Todellista sijaintia ei saada. K\u00e4ytet\u00e4\u00e4n sijaintina Tamperetta...");gPosition_lat=61.49816;gPosition_lon=23.761055;handlePositionUpdate(gPosition_lat,gPosition_lon)}
function updateCurrentLocation(){navigator.geolocation&&(document.getElementById("locationUpdateButtonText").innerHTML="Sijainti...",$("#location-button").removeClass("location-not-available").addClass("location-waiting"),navigator.geolocation.getCurrentPosition(handlePositionUpdateCallback,handlePositionError))}function sortNearestFirst(a,b,c){for(var d=0;d<a.length;++d)a[d].calcDistanceFrom(b,c);a.sort(waypointDistanceSort);return a}
function fillVfrWaypointSelectionData(a,b,c){removeOptions(a);var d=getVfrWayPointsByName(b.vfrPoints);if(0!=d.length){sortNearestFirst(d,c.lat,c.lon);appendOption(a,"-","");for(var e=0;e<d.length;++e)appendOption(a,d[e].name,d[e].name);b!==c&&(a.selectedIndex=1)}}function updatePlanActivationMethods(a,b){removeOptions(a);"yes"==b.atc&&appendOption(a,BY_TWR,"twr");appendOption(a,"Puhelimella maassa (ACC)","phoneOnGound");appendOption(a,"Radiolla ilmassa (ACC, "+b.acc+")","rtfOnAir")}
function getMetar(a,b){document.getElementById(b).innerHTML="";$.getJSON("https://api.openaviationdata.com/v1/metar?station="+a+"&key="+OPENAVIATIONDATA_APIKEY,function(c,d,e){200==c.code&&(document.getElementById(b).innerHTML=c.data[a].raw)})}function getTaf(a,b){document.getElementById(b).innerHTML="";$.getJSON("https://api.openaviationdata.com/v1/taf?station="+a+"&key="+OPENAVIATIONDATA_APIKEY,function(c,d,e){200==c.code&&(document.getElementById(b).innerHTML=c.data[a].raw)})}
function getNotam(a,b){document.getElementById(b).innerHTML="";$.getJSON("https://api.openaviationdata.com/v2/notam/facility?icao="+a+"&key="+OPENAVIATIONDATA_APIKEY,function(a,d,e){if(200==a.code){d="";for(e=0;e<a.data.length;e++)d+=a.data[e].facility_icao+"=== ",d+=a.data[e].report,d+="<br>";document.getElementById(b).innerHTML=d}})}function requestOpenDataDep(a){$("#metarDepId").text("");$("#tafDepId").text("");a!==UNOFFICIAL_AERODROME&&(getMetar(a,"metarDepId"),getTaf(a,"tafDepId"))}
function requestOpenDataDest(a){$("#metarDestId").text("");$("#tafDestId").text("");a!==UNOFFICIAL_AERODROME&&(getMetar(a,"metarDestId"),getTaf(a,"tafDestId"))}var outcode_TOP_LEFT=1,outcode_TOP_RIGHT=2,outcode_BOTTOM_LEFT=4,outcode_BOTTOM_RIGHT=8;function getOutcode(a,b,c,d){var e=0;d>b?c>a?e|=outcode_TOP_RIGHT:c<a&&(e|=outcode_TOP_LEFT):d<b&&(c>a?e|=outcode_BOTTOM_RIGHT:c<a&&(e|=outcode_BOTTOM_LEFT));return e}
function getHorisontalAlignment(a){return(a&outcode_TOP_LEFT||a&outcode_TOP_RIGHT)&&(a&outcode_BOTTOM_LEFT||a&outcode_BOTTOM_RIGHT)?a&outcode_TOP_LEFT?a&outcode_TOP_RIGHT?a&outcode_BOTTOM_LEFT?"left":"right":"left":"right":"center"}function getVerticalAlignment(a){return a&outcode_TOP_LEFT||a&outcode_TOP_RIGHT?a&outcode_BOTTOM_LEFT||a&outcode_BOTTOM_RIGHT?a&outcode_TOP_LEFT?a&outcode_TOP_RIGHT?1:-1:-1:1:-1}
function drawVfrPoint(a,b,c,d,e){a.beginPath();a.moveTo(b,c-5.7735);a.lineTo(b+5,c+2.8868);a.lineTo(b-5,c+2.8868);a.lineTo(b,c-5.7735);a.fill();a.closePath();a.strokeStyle="black";a.stroke();a.font="14px Arial";a.fillStyle="black";a.textAlign=getHorisontalAlignment(e);e=5+15*getVerticalAlignment(e);a.fillText(d,b,c+e)}
function drawAirfield(a,b,c,d,e){a.fillStyle="white";a.beginPath();var f=[0,-2,-4,-6,-7,-7,-6,-4,-2,2,4,6,7,7,6,4,2,0],g=[7,7,6,4,2,-2,-4,-6,-7,-7,-6,-4,-2,2,4,6,7,7];a.moveTo(b+f[0],c+g[0]);for(var h=1;h<f.length;++h)a.lineTo(b+f[h],c+g[h]);a.closePath();a.strokeStyle="black";a.stroke();a.fillStyle="black";a.font="14px Arial";a.textAlign=getHorisontalAlignment(e);e=7+21*getVerticalAlignment(e);a.fillText(d,b,c+e)}
function drawArrow(a,b,c,d,e,f){a.moveTo(b,c);a.lineTo(d,e);a.strokeStyle="black";a.stroke()}
function drawAirspace(a,b,c){var d=c.split(" ");"SFC"==d[0]?(a.strokeStyle="green",a.fillStyle="lightgreen",a.globalAlpha=.5):"FL"==d[0]?(a.strokeStyle="blue",a.fillStyle="lightblue",a.globalAlpha=.2):"FT"==d[1]?(a.strokeStyle="blue",a.fillStyle="lightblue",a.globalAlpha=.4):(debug_log("ERROR: drawAirspace: tuntematon ilmatilan alareunan merkint\u00e4 '"+c+"'"),a.strokeStyle="red",a.fillStyle="red",a.globalAlpha=.7);a.beginPath();a.moveTo(scaleToScreenX(b[0][0]),scaleToScreenY(b[0][1]));for(c=0;c<
b.length;++c)a.lineTo(scaleToScreenX(b[c][0]),scaleToScreenY(b[c][1]));a.closePath();a.fill();a.stroke();a.globalAlpha=1}var gMaxX_gMinX_CANVAS_WIDTH=0,gMaxY_gMinY_CANVAS_HEIGHT=0,gMinX=0,gMaxX=0,gMinY=0,gMaxY=0;
function resizeCanvas(){var a=document.getElementById("mapCanvas"),b=document.getElementById("planCompletionMethod");a.width=b.clientWidth;a.height=b.clientWidth;a.width>MAX_CANVAS_SIZE?(a.width=MAX_CANVAS_SIZE,a.height=MAX_CANVAS_SIZE):a.width<MIN_CANVAS_SIZE&&(a.width=MIN_CANVAS_SIZE,a.height=MIN_CANVAS_SIZE);CANVAS_WIDTH=a.width;CANVAS_HEIGHT=a.height;updateMapData(mapCacheRouteArray)}
function getScreenScale(a){gMinY=a[0].lat;gMaxY=a[0].lat;gMinX=a[0].lon;gMaxX=a[0].lon;for(var b=1;b<a.length;++b)null!=a[b]&&(gMinY=Math.min(gMinY,a[b].lat),gMaxY=Math.max(gMaxY,a[b].lat),gMinX=Math.min(gMinX,a[b].lon),gMaxX=Math.max(gMaxX,a[b].lon));.25>gMaxY-gMinY&&(gMinY-=.125,gMaxY+=.125);.25>gMaxX-gMinX&&(gMinX-=.125,gMaxX+=.125);a=calcDistanceFrom(gMinY,gMinX,gMinY,gMaxX);var b=calcDistanceFrom(gMinY,gMinX,gMaxY,gMinX),c=0,d=0,d=gMaxY-gMinY,c=gMaxX-gMinX;a<b?(a=c/a*((b-a)/2),gMinX-=a,gMaxX+=
a,c=gMaxX-gMinX):(a=d/b*((a-b)/2),gMinY-=a,gMaxY+=a,d=gMaxY-gMinY);d=d*SCREEN_MARGINAL/100;c=c*SCREEN_MARGINAL/100;gMinY-=d;gMaxY+=d;gMinX-=c;gMaxX+=c;gMaxX_gMinX_CANVAS_WIDTH=CANVAS_WIDTH/(gMaxX-gMinX);gMaxY_gMinY_CANVAS_HEIGHT=CANVAS_HEIGHT/(gMaxY-gMinY)}function scaleToScreenX(a){return(a-gMinX)*gMaxX_gMinX_CANVAS_WIDTH}function scaleToScreenY(a){return CANVAS_HEIGHT-(a-gMinY)*gMaxY_gMinY_CANVAS_HEIGHT}
function updateMapData(a){if(void 0!=a){mapCacheRouteArray=a;var b=debug_timestamp_start("getScreenScale");getScreenScale(a);debug_timestamp_ready("getScreenScale",b);b=document.getElementById("mapCanvas").getContext("2d");b.clearRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);var c=debug_timestamp_start("Draw airspaces");if(void 0!=airspaceData)for(var d=0;d<airspaceData.features.length;++d)drawAirspace(b,airspaceData.features[d].geometry.coordinates[0],airspaceData.features[d].properties.bottom);debug_timestamp_ready("Draw airspaces",
c);for(var c=debug_timestamp_start("draw route"),d=a[0],e=a[0],f=0;f<a.length;++f)if(null!==a[f]){for(var e=a[f],g=f+1;g<a.length;++g)if(null!==a[g]){e=a[g];break}g=getOutcode(a[f].lon,a[f].lat,d.lon,d.lat);g|=getOutcode(a[f].lon,a[f].lat,e.lon,e.lat);if(0==f||3==f)e=a[f].icao,"ZZZZ"==e&&(e+="-"+a[f].name),drawAirfield(b,scaleToScreenX(a[f].lon),scaleToScreenY(a[f].lat),e,g);1!=f&&2!=f||drawVfrPoint(b,scaleToScreenX(a[f].lon),scaleToScreenY(a[f].lat),a[f].name,g);drawArrow(b,scaleToScreenX(d.lon),
scaleToScreenY(d.lat),scaleToScreenX(a[f].lon),scaleToScreenY(a[f].lat),"");d=a[f]}a[0]==a[3]&&null==a[1]&&null==a[2]&&("EFHF"==a[0].icao?(b.beginPath(),a=CANVAS_WIDTH/2,d=CANVAS_HEIGHT/2,b.moveTo(a,d),b.quadraticCurveTo(a,d-20,a+20,d-20),b.quadraticCurveTo(a+40,d-20,a+40,d-10),b.quadraticCurveTo(a+35,d+10,a+30,d+20),b.quadraticCurveTo(a+25,d+30,a+15,d+40),b.quadraticCurveTo(a+10,d+50,a+20,d+50),b.quadraticCurveTo(a+30,d+45,a+30,d+30),b.quadraticCurveTo(a+30,d+25,a+15,d+20),b.quadraticCurveTo(a,d+
15,a,d)):(b.beginPath(),a=CANVAS_WIDTH/2,d=CANVAS_HEIGHT/2,b.moveTo(a,d),b.quadraticCurveTo(a,d-50,a+50,d-100),b.quadraticCurveTo(a+70,d-110,a+90,d-50),b.quadraticCurveTo(a+110,d,a+70,d+30),b.quadraticCurveTo(a+30,d+50,a+50,d-50),b.quadraticCurveTo(a+50,d-80,a-20,d-40),b.quadraticCurveTo(a-40,d-30,a-20,d),b.quadraticCurveTo(a,d+20,a,d)),b.stroke());debug_timestamp_ready("draw route",c)}}
function onChangeDepartureAd(){var a=document.getElementById("departure"),b=document.getElementById("destination");$("#departure").selectmenu("refresh");var c=getAerodromeByIndex(a.value),b=getAerodromeByIndex(b.value);document.getElementById("route_departure_ad").innerHTML=c.icao+" ("+c.name+")";fillVfrWaypointSelectionData(document.getElementById("route_departure_rep"),c,b);fillVfrWaypointSelectionData(document.getElementById("route_destination_rep"),b,c);$("#route_departure_rep").selectmenu("refresh");
$("#route_destination_rep").selectmenu("refresh");updatePlanActivationMethods(document.getElementById("planActivationMethod"),c);$("#planActivationMethod").selectmenu("refresh");createFlyingTimeTable();a.value==UNOFFICIAL_AERODROME_INDEX?$("#zzzz_departure_container").slideDown():$("#zzzz_departure_container").slideUp();requestOpenDataDep(c.icao)}
function onChangeDestinationAd(){var a=document.getElementById("departure"),b=document.getElementById("destination");$("#destination").selectmenu("refresh");var a=getAerodromeByIndex(a.value),c=getAerodromeByIndex(b.value);document.getElementById("route_destination_ad").innerHTML=c.icao+" ("+c.name+")";fillVfrWaypointSelectionData(document.getElementById("route_departure_rep"),a,c);fillVfrWaypointSelectionData(document.getElementById("route_destination_rep"),c,a);$("#route_departure_rep").selectmenu("refresh");
$("#route_destination_rep").selectmenu("refresh");updatePlanActivationMethods(document.getElementById("planCompletionMethod"),c);$("#planCompletionMethod").selectmenu("refresh");createFlyingTimeTable();b.value==UNOFFICIAL_AERODROME_INDEX?($("#zzzz_destination_container").slideDown(),setFlightTimeOverride(!0)):($("#zzzz_destination_container").slideUp(),setFlightTimeOverride(!1));requestOpenDataDest(c.icao)}function getTimeFromDistance(a,b){return 0<b?Math.round(a/b*60):"Tarkista lentonopeus!"}
function timeNext5mins(a){return a=5*Math.ceil(a/5)}function convertFlyingTimeToString(a){var b=a%60;a=(a-b)/60;var c="";10>a&&(c+="0");c+=a;10>b&&(c+="0");return c+b}function BearingBetweenCoordinates(a,b,c,d){a=toDeg(Math.atan2(Math.sin(d-b)*Math.cos(c),Math.cos(a)*Math.sin(c)-Math.sin(a)*Math.cos(c)*Math.cos(d-b)));return(a+360)%360}
function Bearing(a,b,c,d){a=toRad(a);b=toRad(b);c=toRad(c);var e=toRad(d);d=BearingBetweenCoordinates(a,b,c,e);a=(BearingBetweenCoordinates(c,e,a,b)+180)%360;return Math.round((d+a)/2)}function Bearing_DMS(a,b,c,d){a=DMS_to_Decimal(a);b=DMS_to_Decimal(b);c=DMS_to_Decimal(c);d=DMS_to_Decimal(d);return Bearing(a,b,c,d)}
function getDistanceInCurrentUnit(a){var b=document.getElementById("aircraftSpeedUnit").value;switch(b){case "K":return+a;case "N":return 1E3*+a/1852;default:debug_log("Error: getDistanceInCurrentUnit() - unknown aircraftSpeedUnit: "+b)}return"unknown"}
function createFlyingTimeTable(){updateAircraftIdentificationToMainpage();var a=document.getElementById("aircraftSpeedUnit").value,b=document.getElementById("aircraftSpeed").value,c="";switch(a){case "K":b=+b;c="km";break;case "N":b=1852*+b/1E3;c="NM";break;default:debug_log("Error: createFlyingTimeTable() - unknown aircraftSpeedUnit: "+a),b=+b}if(0==b)document.getElementById("flyingTime").innerHTML='<a href="#page-plan-settings">T\u00e4yt\u00e4 Perustiedot sivulle puuttuvat tiedot!</a>';else{var d=
document.getElementById("departure").value,e=document.getElementById("route_departure_rep").value,f=document.getElementById("route_destination_rep").value,g=document.getElementById("destination").value,a=[];a.push(getAerodromeByIndex(d));a.push(getVfrWayPointByName(e));a.push(getVfrWayPointByName(f));a.push(getAerodromeByIndex(g));for(var e='<table data-role="table" id="flyingTimeTable" class="table-stripe"><thead><tr class="ui-bar-a">',e=e+'<th data-priority="persist">paikka</th>',e=e+('<th data-priority="2">'+
c+"</th>"),e=e+'<th data-priority="1">min</th>',e=e+"</tr></thead><tbody>",d="<tr>"+("<td>"+a[0].icao+" ("+a[0].name+")</td>"),d=d+"<td>0</td><td>0</td>",d=d+"</tr>",e=e+d,h=a[0],f=0,g=1;g<a.length;++g)if(null!==a[g]){if(h.lat!=a[g].lat||h.lon!=a[g].lon)var d="<tr>",k=addPrefixDigits(Bearing(h.lat,h.lon,a[g].lat,a[g].lon).toString(),0,3),d=d+("<td><center>"+k+"&deg;</center></td>"),d=d+"<td></td>",d=d+"<td></td>",d=d+"</tr>",e=e+d;h=calcDistanceFrom(h.lat,h.lon,a[g].lat,a[g].lon);f+=h;d="<tr>";d=
void 0===a[g].icao?d+("<td>"+a[g].name+"</td>"):d+("<td>"+a[g].icao+" ("+a[g].name+")</td>");d+="<td>"+Math.round(getDistanceInCurrentUnit(h))+"</td>";d+="<td>"+getTimeFromDistance(h,b)+"</td>";d+="</tr>";e+=d;h=a[g]}d="<tr><th>Yhteens\u00e4</th>";d+="<th>"+Math.round(getDistanceInCurrentUnit(f))+" "+c+"</th>";d+="<th>"+getTimeFromDistance(f,b)+" min</th>";d+="</tr>";e+=d;document.getElementById("flyingTime").innerHTML=e;b=getTimeFromDistance(f,b);b=timeNext5mins(b);10>b&&(b=10);gCalculatedFlyingTimeStr=
convertFlyingTimeToString(b);setFlightTimeOverride(!1);updateMapData(a)}}function convertScandinavianLetters(a){a=a.replace(/[\u00e4\u00e5]/g,"a");a=a.replace(/[\u00c4\u00c5]/g,"A");a=a.replace(/\u00f6/g,"o");return a=a.replace(/\u00d6/g,"O")}
function updateFlyingTimeValues(){gSelectedFlyingTimeStr=gCalculatedFlyingTimeStr;if(getFlightTimeOverride()){for(var a="",b=document.getElementsByName("flightTimeHour"),c=0;c<b.length;c++)if(1==b[c].checked){a=b[c].value;break}b=document.getElementsByName("flightTimeMin");for(c=0;c<b.length;c++)if(1==b[c].checked){a+=b[c].value;break}if(4!==a.length)return alert("Itse m\u00e4\u00e4riteltyyn lentoaikaan t\u00e4ytyy antaa sek\u00e4 tunnit ett\u00e4 minuutit!"),!1;if(+a<+gSelectedFlyingTimeStr)return alert("Itse m\u00e4\u00e4ritellyksi lentoajaksi ei voi antaa v\u00e4hemp\u00e4\u00e4 kuin laskelmassa on laskettu!"),
!1;gSelectedFlyingTimeStr=a}}
function updateFlightPlanLink(){for(var a=document.getElementsByName("departureTimeHour"),b=0,c=0;c<a.length;c++)if(a[c].checked){b=+a[c].value;break}for(var a=document.getElementsByName("departureTimeMin"),d=0,c=0;c<a.length;c++)if(a[c].checked){d=+a[c].value;break}if(0===b+d)return alert("L\u00e4ht\u00f6aika ei voi olla heti.\nMuuta l\u00e4ht\u00f6aika j\u00e4rkev\u00e4ksi."),!1;c=new Date;a="";c.setMinutes(timeNext5mins(c.getMinutes())+d);c.setHours(c.getHours()+b);b=c.getUTCHours();d=c.getUTCMinutes();
10>b&&(a+="0");a+=b;10>d&&(a+="0");a+=d;b="&id="+document.getElementById("aircraftIdentification").value;b+="&rules=V&type=G";b+="&aircraft="+document.getElementById("aircraftType").value;b+="&cat=L";b+="&equipment="+document.getElementById("equipment").value;b+="&ssr="+document.getElementById("ssr").value;b+="&ad="+getAerodromeByIndex(document.getElementById("departure").value).icao;b+="&time="+a;b+="&spd="+document.getElementById("aircraftSpeedUnit").value;b+="&speed="+document.getElementById("aircraftSpeed").value;
b+="&lv="+document.getElementById("flight_lv").value;a=document.getElementById("flight_level").value;""==a&&(a=" ");b+="&level="+a;b+="&route=";a="";""!==document.getElementById("route_departure_rep").value&&(a+=document.getElementById("route_departure_rep").value+" ");a+=document.getElementById("route").value;""!==document.getElementById("route_destination_rep").value&&(a+=" "+document.getElementById("route_destination_rep").value);""==a&&(a+=" ");b+=a;b+="&dad="+getAerodromeByIndex(document.getElementById("destination").value).icao;
if(0==updateFlyingTimeValues())return!1;var b=b+("&eet="+gSelectedFlyingTimeStr),c="",a="Muista p\u00e4ivitt\u00e4\u00e4 lomakkeen kentt\u00e4\u00e4n 18:",d=!1,e=document.getElementById("departure").value;e==UNOFFICIAL_AERODROME_INDEX?(c+="DEP%252F"+document.getElementById("zzzz_departure").value+" ",c+=CurrentAerodromeArray[UNOFFICIAL_AERODROME_INDEX].latStr+" ",c+=CurrentAerodromeArray[UNOFFICIAL_AERODROME_INDEX].lonStr+" "):(e=getAerodromeByIndex(e),e.icao==UNOFFICIAL_AERODROME&&(c+="DEP%252F"+
e.name+" ",c+=e.latStr+" ",c+=e.lonStr+" "));e=document.getElementById("destination").value;e==UNOFFICIAL_AERODROME_INDEX?c+="DEST%252F"+document.getElementById("zzzz_destination").value+" ":(e=getAerodromeByIndex(e),e.icao==UNOFFICIAL_AERODROME&&(c+="DEST%252F"+e.name+" ",c+=e.latStr+" ",c+=e.lonStr+" "));isPbnNeeded()&&(e=document.getElementById("equipmentPBN").value,c+="PBN%252F"+e+" ");c+="RMK%252F";"phoneOnGound"==document.getElementById("planActivationMethod").value?c+="DEP "+BY_PHONE_ON_GROUND_STR:
"rtfOnAir"==document.getElementById("planActivationMethod").value&&(e=document.getElementById("departure"),e=getAerodromeByIndex(e.value),c+="DEP "+BY_RTF_ON_AIR_STR+e.acc+" ",e.acc==NOTE_TO_ADD_ACC_FREQ_STR&&(a+="\nL\u00e4ht\u00f6paikan ACC jakso.",d=!0));"phoneOnGound"==document.getElementById("planCompletionMethod").value?c+="ARR "+BY_PHONE_ON_GROUND_STR:"rtfOnAir"==document.getElementById("planCompletionMethod").value&&(e=document.getElementById("destination"),e=getAerodromeByIndex(e.value),c+=
"ARR "+BY_RTF_ON_AIR_STR+e.acc+" ",e.acc==NOTE_TO_ADD_ACC_FREQ_STR&&(a+="\nLaskupaikan ACC jakso.",d=!0));for(var c=c+("PIC TEL "+document.getElementById("pilotTel").value),b=b+("&other="+c),e="",f=document.getElementsByName("enduranceHour"),c=0;c<f.length;c++)if(f[c].checked){e=f[c].value;break}f=document.getElementsByName("enduranceMin");for(c=0;c<f.length;c++)if(f[c].checked){e+=f[c].value;break}if(0===+e)return alert("Toiminta-aika puuttuu!\nAseta oikea toiminta-aika."),!1;b+="&endurance="+e;
e="";f=document.getElementsByName("persons");for(c=0;c<f.length;c++)if(f[c].checked){e=f[c].value;break}b+="&person="+e;b+="&markings="+document.getElementById("aircraftColor").value;"on"==document.getElementById("pyrotechnicsOnBoard").value&&(b+="&remarks="+PYROTECHNICS_NOTE_REMARKS);b+="&pic="+document.getElementById("pilot").value;b+="&tel="+document.getElementById("pilotTel").value;b+="&filed="+document.getElementById("pilot").value;b=convertScandinavianLetters(b);flightPlanLink="http://ais.fi/C/flightplan/efpl_lomake/"+
b;d&&alert(a);return!0}
function getPlanForStoring(){for(var a={},b=document.getElementsByName("departureTimeHour"),c=0,d=0;d<b.length;d++)if(b[d].checked){c=+b[d].value;break}for(var e=document.getElementsByName("departureTimeMin"),d=b=0;d<e.length;d++)if(e[d].checked){b=+e[d].value;break}if(0===c+b)return alert("L\u00e4ht\u00f6aika ei voi olla heti.\nMuuta l\u00e4ht\u00f6aika j\u00e4rkev\u00e4ksi."),!1;d=new Date;d.setMinutes(timeNext5mins(d.getMinutes())+b);d.setHours(d.getHours()+c);d.getUTCHours();d.getUTCMinutes();
"phoneOnGound"==document.getElementById("planActivationMethod").value?a.activation_method=BY_PHONE_ON_GROUND_STR_WITH_PHONE:"rtfOnAir"==document.getElementById("planActivationMethod").value?(c=document.getElementById("departure"),c=getAerodromeByIndex(c.value),a.activation_method=BY_RTF_ON_AIR_STR+c.acc+" "):a.activation_method=BY_TWR;"phoneOnGound"==document.getElementById("planCompletionMethod").value?a.completion_method=BY_PHONE_ON_GROUND_STR_WITH_PHONE:"rtfOnAir"==document.getElementById("planCompletionMethod").value?
(c=document.getElementById("destination"),c=getAerodromeByIndex(c.value),a.completion_method=BY_RTF_ON_AIR_STR+c.acc+" "):a.completion_method=BY_TWR;a.takeoff_time=d.toJSON();a.identification=document.getElementById("aircraftIdentification").value;a.departure=getAerodromeByIndex(document.getElementById("departure").value).icao;a.dep_name=getAerodromeByIndex(document.getElementById("departure").value).name;a.dep_route=document.getElementById("route_departure_rep").value;d=document.getElementById("route").value;
a.route=$("<p>"+d+"</p>").text();a.dest_route=document.getElementById("route_destination_rep").value;a.destination=getAerodromeByIndex(document.getElementById("destination").value).icao;a.dest_name=getAerodromeByIndex(document.getElementById("destination").value).name;d=document.getElementById("flight_lv").value;"VFR"!==d&&(d+=document.getElementById("flight_level").value);a.flight_level=d;c="";b=document.getElementsByName("enduranceHour");for(d=0;d<b.length;d++)if(b[d].checked){c=b[d].value;break}b=
document.getElementsByName("enduranceMin");for(d=0;d<b.length;d++)if(b[d].checked){c+=b[d].value;break}a.endurance=c;c=document.getElementsByName("persons");for(d=0;d<c.length;d++)if(c[d].checked){a.persons=c[d].value;break}updateFlyingTimeValues();a.flight_time=gSelectedFlyingTimeStr;return a}function storeCurrentPlan(){var a=getPlanForStoring();addPlanToStorage(a);updateStoredPlanList()}
function onClickFlightPlanLinkButton(){if(isAllSettingsAvailable())try{updateFlightPlanLink()&&(storeCurrentPlan(),window.open(flightPlanLink))}catch(a){alert("Lentosuunnitelman luominen ei onnistunut.\n"+a)}else alert("Perustietoja puuttuu viel\u00e4.\nLis\u00e4\u00e4 puuttuvat tiedot Perustiedot sivulle, niin lentosuunnitelma saadaan t\u00e4ytetty\u00e4 oikein."),window.open("#page-plan-settings","_self")}
function getNotamLink(a){if("EFAA"<=a&&"EFLP">=a)return"http://www.ais.fi/ais/bulletins/envfra.htm#"+a;if("EFMA"<=a&&"EFYL">=a)return"http://www.ais.fi/ais/bulletins/envfrm.htm#"+a};