var log="",VfrRepArray,CurrentAerodromeArray,OfficialAerodromeArray,ZZZZFieldArray,gPosition_lat,gPosition_lon,flightPlanLink,gCalculatedFlyingTimeStr,gSelectedFlyingTimeStr,dateOfUpdateStr="2013-09-19T00:00:00Z",VFRPortFilename_before_2013_sep_19="17NOV2011.xml",AerodromesFilename_before_2013_sep_19="aerodromes.xml",VFRPortFilename="EF_VFRREP_19SEP2013.xml",AerodromesFilename="aerodromes_19SEP2013.xml",ZZZZFieldsFilename="zzzz_fields.xml",UNOFFICIAL_AERODROME="ZZZZ",UNOFFICIAL_AERODROME_INDEX=0,
BY_PHONE_ON_GROUND_STR="PHONE ACC ",BY_PHONE_ON_GROUND_STR_WITH_PHONE="PHONE ACC 032865172 ",BY_RTF_ON_AIR_STR="RTF ACC ",BY_TWR="- (torni)",overrideFlightTime=!0;function debug_log(a){log+=a+"<br>";document.getElementById("log").innerHTML=log}function getFlightTimeOverride(){return overrideFlightTime}
function setFlightTimeOverride(a){if(overrideFlightTime!=a)if(overrideFlightTime=a,!0==overrideFlightTime)$("#overrideFlightTimeContainer").slideDown();else{$("#overrideFlightTimeContainer").slideUp();var b=document.getElementsByName("flightTimeHour");for(a=0;a<b.length;a++)$("#flightTime"+b[a].value+"h").removeAttr("checked").checkboxradio("refresh");b=document.getElementsByName("flightTimeMin");for(a=0;a<b.length;a++)$("#flightTime"+b[a].value).removeAttr("checked").checkboxradio("refresh");gSelectedFlyingTimeStr=
gCalculatedFlyingTimeStr}}function onFlightTimeOverrideButton(){setFlightTimeOverride(!getFlightTimeOverride())}function isEverythingReady(){var a=!0;void 0==VfrRepArray&&(a=!1);void 0==OfficialAerodromeArray&&(a=!1);void 0==ZZZZFieldArray&&(a=!1);return a}
function continueIfEverythingIsReady(){isEverythingReady()&&(PopulateSelections(),onChangeDepartureAd(),onChangeDestinationAd());void 0!==OfficialAerodromeArray&&void 0!==ZZZZFieldArray&&void 0!==gPosition_lat&&handlePositionUpdate(gPosition_lat,gPosition_lon)}
function handlePositionError(a){switch(a.code){case a.PERMISSION_DENIED:debug_log("Sijainti ei ole saatavilla (PERMISSION_DENIED)");break;case a.POSITION_UNAVAILABLE:debug_log("Sijainti ei ole saatavilla (POSITION_UNAVAILABLE)");break;case a.TIMEOUT:debug_log("Sijainti ei ole saatavilla (TIMEOUT)");break;default:debug_log("Sijainti ei ole saatavilla (unknown error)")}fakeCurrentLocation()}function handlePositionUpdateCallback(a){handlePositionUpdate(a.coords.latitude,a.coords.longitude)}
function handlePositionUpdate(a,b){gPosition_lat=a;gPosition_lon=b;if(void 0!==OfficialAerodromeArray&&void 0!==ZZZZFieldArray){"enabled"==document.getElementById("zzzzFieldsEnabled").value?(debug_log("Kaikki lentokent\u00e4t k\u00e4yt\u00f6ss\u00e4."),CurrentAerodromeArray=OfficialAerodromeArray.concat(ZZZZFieldArray)):(debug_log("Vain viralliset lentokent\u00e4t k\u00e4yt\u00f6ss\u00e4."),CurrentAerodromeArray=OfficialAerodromeArray);0<CurrentAerodromeArray.length&&CurrentAerodromeArray[0].icao===
UNOFFICIAL_AERODROME&&(CurrentAerodromeArray[0].lat=a,CurrentAerodromeArray[0].lon=b,CurrentAerodromeArray[0].latStr=DMS_to_DM(Decimal_to_DMS_lat(a)),CurrentAerodromeArray[0].lonStr=DMS_to_DM(Decimal_to_DMS_lon(b)));for(var c=1;c<CurrentAerodromeArray.length;++c)CurrentAerodromeArray[c].calcDistanceFrom(a,b);CurrentAerodromeArray.sort(waypointDistanceSort);debug_log("Nykyinen sijainti "+Math.round(CurrentAerodromeArray[1].distance)+" km kent\u00e4lt\u00e4 "+CurrentAerodromeArray[1].name+", "+CurrentAerodromeArray[1].icao);
PopulateSelections();onChangeDepartureAd();onChangeDestinationAd()}}function addPrefixDigits(a,b,c){for(;a.length<c;)a=b+a;return a}
function DMS_to_DM(a){var b=0,c=0,d=0,e=a.substr(a.length-1,1).toUpperCase();7==a.length?(b=parseInt(a.substr(0,2),10),c=parseInt(a.substr(2,2),10),d=parseInt(a.substr(4,2),10)):8==a.length?(b=parseInt(a.substr(0,3),10),c=parseInt(a.substr(3,2),10),d=parseInt(a.substr(5,2),10)):debug_log("ERROR: DMS_to_DM(): DMS coordinate does not look valid!");30<=d&&(c+=1);60==c&&(c=0,b+=1);switch(e){case "N":case "S":return addPrefixDigits(b.toString(),"0",2)+addPrefixDigits(c.toString(),"0",2)+e;case "W":case "E":return addPrefixDigits(b.toString(),
"0",3)+addPrefixDigits(c.toString(),"0",2)+e;default:debug_log("ERROR: DMS_to_DM(): DMS coordinate does not look valid! No letter at the end (or wrong letter).")}}
function DMS_to_Decimal(a){var b=1,c=0,d=0,e=0;switch(a.substr(a.length-1,1).toUpperCase()){case "N":case "E":a=a.substr(0,a.length-1);break;case "S":case "W":b=-1,a=a.substr(0,a.length-1)}6==a.length?(c=parseInt(a.substr(0,2),10),d=parseInt(a.substr(2,2),10),e=parseInt(a.substr(4,2),10)):7==a.length?(c=parseInt(a.substr(0,3),10),d=parseInt(a.substr(3,2),10),e=parseInt(a.substr(5,2),10)):debug_log("ERROR: DMS coordinate does not look valid!");return b*(c+(60*d+e)/3600)}
function Decimal_to_DMS_lat(a){var b,c,d="N";0>a&&(d="S");b=parseInt(a);a=60*(a-b);c=parseInt(a);a-=c;a*=60;a=Math.round(a);60==a&&(a=0,c+=1);60==c&&(c=0,b+=1);return addPrefixDigits(b.toString(),"0",2)+addPrefixDigits(c.toString(),"0",2)+addPrefixDigits(a.toString(),"0",2)+d}
function Decimal_to_DMS_lon(a){var b,c,d="E";0>a&&(d="W");b=parseInt(a);a=60*(a-b);c=parseInt(a);a-=c;a*=60;a=Math.round(a);60==a&&(a=0,c+=1);60==c&&(c=0,b+=1);return addPrefixDigits(b.toString(),"0",3)+addPrefixDigits(c.toString(),"0",2)+addPrefixDigits(a.toString(),"0",2)+d}function Waypoint(a,b,c){this.name=a;this.lat=b;this.lon=c;this.distance=0}function toRad(a){return a*Math.PI/180}
function calcDistanceFrom(a,b,c,d){var e=toRad(c-a);b=toRad(d-b);a=toRad(a);c=toRad(c);a=Math.sin(e/2)*Math.sin(e/2)+Math.sin(b/2)*Math.sin(b/2)*Math.cos(a)*Math.cos(c);return 12742*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))}Waypoint.prototype.getDistance=function(){return this.distance};Waypoint.prototype.calcDistanceFrom=function(a,b){this.distance=calcDistanceFrom(this.lat,this.lon,a,b)};Aerodrome.prototype=new Waypoint;Aerodrome.prototype.constructor=Aerodrome;
function Aerodrome(a,b,c,d,e,f,g){Waypoint.call(this,a,DMS_to_Decimal(c),DMS_to_Decimal(d));this.latStr=DMS_to_DM(c);this.lonStr=DMS_to_DM(d);this.icao=b;this.atc=e;this.acc=f;this.vfrPoints=g}function waypointDistanceSort(a,b){return a.distance-b.distance}function vfrPortXmlResponseHandler(){if(this.readyState==this.DONE||4==this.readyState)200==this.status&&null!==this.responseXML?vfrPortReadyHandler(this.responseXML):debug_log("ERROR: vfrPortXmlResponseHandler - error: status="+this.status)}
function aerodromeXmlResponseHandler(){if(this.readyState==this.DONE||4==this.readyState)200==this.status&&null!==this.responseXML?aerodromeReadyHandler(this.responseXML):debug_log("ERROR: aerodromeXmlResponseHandler - error: status="+this.status)}function zzzzFieldXmlResponseHandler(){if(this.readyState==this.DONE||4==this.readyState)200==this.status&&null!==this.responseXML?zzzzFieldReadyHandler(this.responseXML):debug_log("ERROR: zzzzFieldXmlResponseHandler - error: status="+this.status)}
function loadXMLDoc(a,b){var c;window.XMLHttpRequest?c=new XMLHttpRequest:(c=new ActiveXObject("Microsoft.XMLHTTP"),debug_log("going IE way"));c.onreadystatechange=b;c.open("GET",a,!0);c.send()}
function vfrPortReadyHandler(a){try{var b=a.getElementsByTagName("metadata");if(0<b.length){var c=b[0].getElementsByTagName("time")[0].childNodes[0].nodeValue,d=new Date(c);debug_log("VFR ilmoittautumispisteet p\u00e4iv\u00e4tty: "+d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate())}}catch(e){debug_log("Could not read xml date: "+e)}a=a.getElementsByTagName("wpt");VfrRepArray=[];for(b=0;b<a.length;++b)if(c=a[b].getElementsByTagName("name")[0].childNodes[0].nodeValue,"Compulsory"==a[b].getElementsByTagName("desc")[0].childNodes[0].nodeValue){var d=
a[b].attributes.getNamedItem("lat").nodeValue,f=a[b].attributes.getNamedItem("lon").nodeValue;VfrRepArray.push(new Waypoint(c,d,f))}debug_log("=> "+VfrRepArray.length+" VFR ilmoittautumispistett\u00e4.");loadXMLDoc(ZZZZFieldsFilename,zzzzFieldXmlResponseHandler)}
function aerodromeReadyHandler(a){try{var b=a.getElementsByTagName("gpx");0<b.length&&debug_log("Lentokentt\u00e4tiedot p\u00e4iv\u00e4tty: "+b[0].attributes.getNamedItem("created").nodeValue)}catch(c){debug_log("Could not read xml date: "+c)}try{var d=a.getElementsByTagName("aerodrome");OfficialAerodromeArray=[];OfficialAerodromeArray.push(new Aerodrome("Ep\u00e4virallinen",UNOFFICIAL_AERODROME,"000000N","0000000E","no","LIS\u00c4\u00c4_ACC_JAKSO",[]));for(a=0;a<d.length;++a){for(var e=d[a].getElementsByTagName("name")[0].childNodes[0].nodeValue,
f=d[a].getElementsByTagName("icao")[0].childNodes[0].nodeValue,g=d[a].getElementsByTagName("atc")[0].childNodes[0].nodeValue,h=d[a].getElementsByTagName("acc")[0].childNodes[0].nodeValue.replace("."," "),k=d[a].attributes.getNamedItem("lat").nodeValue,l=d[a].attributes.getNamedItem("lon").nodeValue,m=d[a].getElementsByTagName("vfrpoint"),b=[],n=0;n<m.length;++n)b.push(m[n].childNodes[0].nodeValue);OfficialAerodromeArray.push(new Aerodrome(e,f,k,l,g,h,b))}}catch(p){alert(p)}debug_log("=> "+OfficialAerodromeArray.length+
" lentokentt\u00e4\u00e4.");loadXMLDoc(VFRPortFilename,vfrPortXmlResponseHandler)}
function zzzzFieldReadyHandler(a){try{var b=a.getElementsByTagName("gpx");0<b.length&&debug_log("Ep\u00e4virallisten lentopaikkojen tiedot p\u00e4iv\u00e4tty: "+b[0].attributes.getNamedItem("created").nodeValue)}catch(c){debug_log("Could not read xml date: "+c)}try{var d=a.getElementsByTagName("aerodrome");ZZZZFieldArray=[];for(a=0;a<d.length;++a){var e=d[a].getElementsByTagName("name")[0].childNodes[0].nodeValue,f=d[a].getElementsByTagName("icao")[0].childNodes[0].nodeValue,g=d[a].getElementsByTagName("atc")[0].childNodes[0].nodeValue,
h=d[a].getElementsByTagName("acc")[0].childNodes[0].nodeValue.replace("."," "),k=d[a].attributes.getNamedItem("lat").nodeValue,l=d[a].attributes.getNamedItem("lon").nodeValue;d[a].getElementsByTagName("vfrpoint");ZZZZFieldArray.push(new Aerodrome(e,f,k,l,g,h,[]))}}catch(m){alert(m)}debug_log("=> "+ZZZZFieldArray.length+" ep\u00e4virallista lentopaikkaa.");continueIfEverythingIsReady()}function removeOptions(a){for(;0<a.length;)a.remove(0)}
function appendOption(a,b,c){var d=document.createElement("option");d.text=b;d.value=c;try{a.add(d,null)}catch(e){a.add(d)}}function getAerodromeByIndex(a){return void 0===CurrentAerodromeArray?(debug_log("NOTE: getAerodromeByIndex(): CurrentAerodromeArray not yet loaded"),null):a>=CurrentAerodromeArray.length?(debug_log("ERROR: getAerodromeByIndex(): index "+a+" too big. CurrentAerodromeArray.length="+CurrentAerodromeArray.length),null):CurrentAerodromeArray[a]}
function getVfrWayPointByName(a){if(void 0===VfrRepArray)return null;for(var b=0;b<VfrRepArray.length;++b)if(a==VfrRepArray[b].name)return VfrRepArray[b];return null}function getVfrWayPointsByName(a){for(var b=[],c=0;c<a.length;++c){var d=getVfrWayPointByName(a[c]);null!==d&&b.push(d)}return b}
function PopulateSelections(){var a=document.getElementById("departure"),b=document.getElementById("destination");removeOptions(a);removeOptions(b);void 0===CurrentAerodromeArray&&(CurrentAerodromeArray=OfficialAerodromeArray);var c=999,d="";switch(document.getElementById("aircraftSpeedUnit").value){case "K":c=1;d="km";break;case "N":c=1/1.852,d="NM"}for(var e=0;e<CurrentAerodromeArray.length;++e){var f=CurrentAerodromeArray[e].icao+" ("+CurrentAerodromeArray[e].name;0!==Math.round(CurrentAerodromeArray[e].distance)&&
(f+=", "+Math.round(CurrentAerodromeArray[e].distance*c)+" "+d);f+=")";appendOption(a,f,e);appendOption(b,f,e)}a.selectedIndex=1;b.selectedIndex=1}
function onChangeFlightLv(){var a=document.getElementById("flight_level");a.value="";switch(document.getElementById("flight_lv").value){case "F":case "A":a.setAttribute("maxlength",3);$("#flight_level_container").slideDown();break;case "S":case "M":a.setAttribute("maxlength",4);$("#flight_level_container").slideDown();break;case "VFR":$("#flight_level_container").slideUp()}}
function onChangeFlightLevel(){var a=document.getElementById("flight_level").value;switch(document.getElementById("flight_lv").value){case "F":case "A":document.getElementById("flight_level").value=addPrefixDigits(a,"0",3);break;case "S":case "M":document.getElementById("flight_level").value=addPrefixDigits(a,"0",4)}}
function clearAircraftSettingsFields(){document.getElementById("aircraftIdentification").value="";document.getElementById("aircraftType").value="";document.getElementById("equipment").value="";document.getElementById("equipmentPBN").value="";document.getElementById("ssr").value="C";document.getElementById("aircraftSpeedUnit").value="K";document.getElementById("aircraftSpeed").value="";document.getElementById("aircraftColor").value="";$("#ssr").selectmenu("refresh");$("#aircraftSpeedUnit").selectmenu("refresh")}
function updateAircraftSelectionList(){var a=localStorage.getItem("aircraftSettingsTable");if(null==a)debug_log("ERROR: updateAircraftSelectionList() - table is null");else{var a=a.split(","),b=document.getElementById("aircraftSettingsList");removeOptions(b);for(var c=localStorage.getItem("currentSettingsId"),d=0,e=0;e<a.length;++e){var f=a[e];f==c&&(d=e);var g=localStorage.getItem(f+"_aircraftIdentification");null==g&&(g="Nimet\u00f6n");appendOption(b,g,f)}appendOption(b,"Lis\u00e4\u00e4 kone","NewAircraft");
b.selectedIndex=d;try{$("#aircraftSettingsList").selectmenu("refresh")}catch(h){}}}function onChangeAircraftSettings(){var a=document.getElementById("aircraftSettingsList").value;clearAircraftSettingsFields();"NewAircraft"==a?addNewAircraftSettings():(localStorage.setItem("currentSettingsId",a),updateFromLocalStorage(),onChangeAircraftSpeed());updateAircraftIdentificationToMainpage()}
function removeAircraftDataWithPrefix(a){localStorage.removeItem(a+"aircraftIdentification");localStorage.removeItem(a+"aircraftType");localStorage.removeItem(a+"equipment");localStorage.removeItem(a+"equipmentPBN");localStorage.removeItem(a+"ssr");localStorage.removeItem(a+"aircraftSpeedUnit");localStorage.removeItem(a+"aircraftSpeed");localStorage.removeItem(a+"aircraftColor")}
function deleteCurrentAircraftSettings(){var a=localStorage.getItem("currentSettingsId"),b=localStorage.getItem("aircraftSettingsTable");if(null==b)debug_log("ERROR: deleteCurrentAircraftSettings() - table == null");else{var b=b.split(","),c=0;1<b.length&&(c=b.indexOf(a),b.splice(c,1),0<c&&c--,localStorage.setItem("aircraftSettingsTable",b));removeAircraftDataWithPrefix(a+"_");a=b[c];localStorage.setItem("currentSettingsId",a);updateAircraftSelectionList();onChangeAircraftSettings()}}
function addNewAircraftSettings(){var a=localStorage.getItem("aircraftSettingsTable");if(null==a)debug_log("ERROR: addNewAircraftSettings() - table == null");else{var a=a.split(","),b=0;0<a.length&&(b=Number(a[a.length-1])+1);a.push(b);localStorage.setItem("aircraftSettingsTable",a);localStorage.setItem("currentSettingsId",b)}}
function updateAircraftIdentificationToMainpage(){var a=document.getElementById("aircraftIdentification").value;0!==a.length?document.getElementById("selectedPlane").innerHTML="Kone: "+a:document.getElementById("selectedPlane").innerHTML=""}
function onChangeAircraftIdentification(){var a=localStorage.getItem("currentSettingsId");localStorage.setItem(a+"_aircraftIdentification",document.getElementById("aircraftIdentification").value);updateAircraftSelectionList();updateAircraftIdentificationToMainpage()}function onChangeAircraftType(){var a=localStorage.getItem("currentSettingsId");localStorage.setItem(a+"_aircraftType",document.getElementById("aircraftType").value)}
function isPbnNeeded(){var a=document.getElementById("equipment").value;return-1!==a.indexOf("R")||-1!==a.indexOf("r")?!0:!1}function onChangeEquipment(){var a=localStorage.getItem("currentSettingsId"),b=document.getElementById("equipment").value;localStorage.setItem(a+"_equipment",b);onChangeSsr();isPbnNeeded()?$("#equipment_PBN_container").slideDown():(document.getElementById("equipmentPBN").value="",onChangeEquipmentPBN(),$("#equipment_PBN_container").slideUp())}
function onChangeSsr(){var a=localStorage.getItem("currentSettingsId");localStorage.setItem(a+"_ssr",document.getElementById("ssr").value)}function onChangeEquipmentPBN(){var a=localStorage.getItem("currentSettingsId");localStorage.setItem(a+"_equipmentPBN",document.getElementById("equipmentPBN").value)}
function onChangeAircraftSpeed(){var a=document.getElementById("aircraftSpeed").value,a=addPrefixDigits(a,"0",4);document.getElementById("aircraftSpeed").value=a;var b=localStorage.getItem("currentSettingsId");localStorage.setItem(b+"_aircraftSpeedUnit",document.getElementById("aircraftSpeedUnit").value);localStorage.setItem(b+"_aircraftSpeed",a);PopulateSelections();onChangeDepartureAd();onChangeDestinationAd()}
function onChangePilot(){localStorage.setItem("pilot",document.getElementById("pilot").value)}function onChangePilotTel(){localStorage.setItem("pilotTel",document.getElementById("pilotTel").value)}function onChangeAircraftColor(){var a=localStorage.getItem("currentSettingsId");localStorage.setItem(a+"_aircraftColor",document.getElementById("aircraftColor").value)}
function onChangeZzzzFieldsEnabled(){localStorage.setItem("zzzzFieldsEnabled",document.getElementById("zzzzFieldsEnabled").value);handlePositionUpdate(gPosition_lat,gPosition_lon)}
function convertOldSettings(){localStorage.setItem("aircraftSettingsTable",[0]);localStorage.setItem("currentSettingsId",0);var a=localStorage.getItem("aircraftIdentification");null!==a&&localStorage.setItem("0_aircraftIdentification",a);a=localStorage.getItem("aircraftType");null!==a&&localStorage.setItem("0_aircraftType",a);a=localStorage.getItem("equipment");null!==a&&localStorage.setItem("0_equipment",a);a=localStorage.getItem("ssr");null!==a&&localStorage.setItem("0_ssr",a);a=localStorage.getItem("aircraftSpeedUnit");
null!==a&&localStorage.setItem("0_aircraftSpeedUnit",a);a=localStorage.getItem("aircraftSpeed");null!==a&&localStorage.setItem("0_aircraftSpeed",a);a=localStorage.getItem("aircraftColor");null!==a&&localStorage.setItem("0_aircraftColor",a);removeAircraftDataWithPrefix("")}
function updateFromLocalStorage(){var a=localStorage.getItem("currentSettingsId");null==a&&(convertOldSettings(),a=localStorage.getItem("currentSettingsId"));var b=localStorage.getItem(a+"_aircraftIdentification");null!==b&&(document.getElementById("aircraftIdentification").value=b);b=localStorage.getItem(a+"_aircraftType");null!==b&&(document.getElementById("aircraftType").value=b);b=localStorage.getItem(a+"_equipment");null!==b&&(document.getElementById("equipment").value=b);b=localStorage.getItem(a+
"_ssr");if(null!==b){document.getElementById("ssr").value=b;try{$("#ssr").selectmenu("refresh")}catch(c){}}isPbnNeeded()?$("#equipment_PBN_container").slideDown():$("#equipment_PBN_container").slideUp();document.getElementById("equipmentPBN").value="";b=localStorage.getItem(a+"_equipmentPBN");null!==b&&(document.getElementById("equipmentPBN").value=b);b=localStorage.getItem(a+"_aircraftSpeedUnit");if(null!==b){document.getElementById("aircraftSpeedUnit").value=b;try{$("#aircraftSpeedUnit").selectmenu("refresh")}catch(d){}}b=
localStorage.getItem(a+"_aircraftSpeed");null!==b&&(document.getElementById("aircraftSpeed").value=b);b=localStorage.getItem("pilot");null!==b&&(document.getElementById("pilot").value=b);b=localStorage.getItem("pilotTel");null!==b&&(document.getElementById("pilotTel").value=b);a=localStorage.getItem(a+"_aircraftColor");null!==a&&(document.getElementById("aircraftColor").value=a);a=localStorage.getItem("zzzzFieldsEnabled");null!==a&&(document.getElementById("zzzzFieldsEnabled").value=a);updateAircraftSelectionList()}
function isValid(a){return void 0===a||0>=a.length?!1:!0}
function isAllSettingsAvailable(){try{var a=document.getElementById("aircraftIdentification").value,b=document.getElementById("aircraftType").value,c=document.getElementById("equipment").value,d="ok";isPbnNeeded()&&(d=document.getElementById("equipmentPBN").value);var e=document.getElementById("ssr").value,f=document.getElementById("aircraftSpeedUnit").value,g=document.getElementById("aircraftSpeed").value,h=document.getElementById("pilot").value,k=document.getElementById("pilotTel").value,l=document.getElementById("aircraftColor").value;
return void 0===gCalculatedFlyingTimeStr?!1:isValid(a)&&isValid(b)&&isValid(c)&&isValid(e)&&isValid(d)&&isValid(f)&&isValid(g)&&isValid(h)&&isValid(k)&&isValid(l)?!0:!1}catch(m){return!1}}function getPlansFromStorage(){var a=localStorage.getItem("storedPlans");return null==a?[]:JSON.parse(a)}function addPlanToStorage(a){var b=getPlansFromStorage();b.push(a);localStorage.setItem("storedPlans",JSON.stringify(b))}
function deleteCurrentStoredPlan(){var a=getPlansFromStorage(),b=localStorage.getItem("selectedStoredPlanIndex");a.splice(b,1);localStorage.setItem("storedPlans",JSON.stringify(a));updateStoredPlanList()}function removeOldPlansFromStorage(){var a=getPlansFromStorage(),b=[],c=new Date;c.setTime((new Date).getTime()-864E5);for(var d=0;d<a.length;d++)new Date(a[d].takeoff_time)>=c&&b.push(a[d]);localStorage.setItem("storedPlans",JSON.stringify(b))}
function getTimeIn4digits(a){var b="",c=a.getHours();a=a.getMinutes();10>c&&(b+="0");b+=c;10>a&&(b+="0");return b+a}function setSelectedStoredPlanIndex(a){localStorage.setItem("selectedStoredPlanIndex",a)}
function updateStoredPlanList(){removeOldPlansFromStorage();var a=getPlansFromStorage();$("#storedPlanList").find("li").remove();localStorage.removeItem("selectedStoredPlanIndex");for(var b=0;b<a.length;b++){var c=getTimeIn4digits(new Date(a[b].takeoff_time)),d="";void 0!==a[b].dep_route&&(d+=a[b].dep_route+" ");void 0!==a[b].route&&(d+=a[b].route+" ");void 0!==a[b].dest_route&&(d+=a[b].dest_route);c="<li class='storedPlanListItem'><a href='#page-stored-plan' onClick='setSelectedStoredPlanIndex("+
b+")'><h2>"+a[b].departure+"-"+a[b].destination+"</h2><p class='ui-li-aside'>L\u00e4ht\u00f6aika: <strong>"+c+"</strong> (sa)</p><p><strong>Reitti: "+d+"</strong></p><p>Lentoaika: "+a[b].flight_time+"</p><p>P\u00e4\u00e4tt\u00e4minen: "+a[b].completion_method+"</p></a>";a[b].destination!==UNOFFICIAL_AERODROME&&(c+="<a href='"+getNotamLink(a[b].destination)+"' rel='external'>Notam</a>");c+="</li>";$("#storedPlanList").append($(c))}$(".buttonContainer").hide();$("#storedPlanList").listview("refresh")}
function initStoredPlanPageHandler(){$("#page-stored-plan").on("pagebeforeshow",function(a){a=getPlansFromStorage();var b=localStorage.getItem("selectedStoredPlanIndex");$("#storedPlanAircraftIdentification").val(a[b].identification);$("#storedPlanDeparture").val(a[b].departure+" "+a[b].dep_name);$("#storedPlanDestination").val(a[b].destination+" "+a[b].dest_name);$("#storedPlanRoute").val(a[b].dep_route+" "+a[b].route+" "+a[b].dest_route);$("#storedPlanFlightLevel").val(a[b].flight_level);$("#storedPlanTakeoffTime").val(getTimeIn4digits(new Date(a[b].takeoff_time))+
" (sa)");$("#storedPlanFlightTime").val(a[b].flight_time);$("#storedPlanEndurance").val(a[b].endurance);$("#storedPlanPersons").val(a[b].persons);$("#storedPlanDepMethod").val(a[b].activation_method);$("#storedPlanArrMethod").val(a[b].completion_method);a[b].activation_method!==BY_PHONE_ON_GROUND_STR_WITH_PHONE&&a[b].completion_method!==BY_PHONE_ON_GROUND_STR_WITH_PHONE?$("#callAccButton").hide():$("#callAccButton").show()})}
function onLoad(){var a=new Date(dateOfUpdateStr);(new Date).getTime()<a.getTime()&&(VFRPortFilename=VFRPortFilename_before_2013_sep_19,AerodromesFilename=AerodromesFilename_before_2013_sep_19);loadXMLDoc(AerodromesFilename,aerodromeXmlResponseHandler);navigator.geolocation?updateCurrentLocation():(debug_log("Geolocation ei ole tuettu selaimessa."),fakeCurrentLocation());updateFromLocalStorage();onChangeFlightLv();updateStoredPlanList();initStoredPlanPageHandler()}
function fakeCurrentLocation(){debug_log("Todellista sijaintia ei saada. K\u00e4ytet\u00e4\u00e4n sijaintina Tamperetta...");gPosition_lat=61.49816;gPosition_lon=23.761055;handlePositionUpdate(gPosition_lat,gPosition_lon)}function updateCurrentLocation(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(handlePositionUpdateCallback,handlePositionError)}function sortNearestFirst(a,b,c){for(var d=0;d<a.length;++d)a[d].calcDistanceFrom(b,c);a.sort(waypointDistanceSort);return a}
function fillVfrWaypointSelectionData(a,b,c){removeOptions(a);var d=getVfrWayPointsByName(b.vfrPoints);if(0!=d.length){sortNearestFirst(d,c.lat,c.lon);appendOption(a,"-","");for(var e=0;e<d.length;++e)appendOption(a,d[e].name,d[e].name);b!==c&&(a.selectedIndex=1)}}function updatePlanActivationMethods(a,b){removeOptions(a);"yes"==b.atc&&appendOption(a,BY_TWR,"twr");appendOption(a,"Puhelimella maassa (ACC)","phoneOnGound");appendOption(a,"Radiolla ilmassa (ACC, "+b.acc+")","rtfOnAir")}
function onChangeDepartureAd(){var a=document.getElementById("departure"),b=document.getElementById("destination");$("#departure").selectmenu("refresh");var c=getAerodromeByIndex(a.value);document.getElementById("route_departure_ad").innerHTML=c.icao+" ("+c.name+")";c=getAerodromeByIndex(a.value);b=getAerodromeByIndex(b.value);fillVfrWaypointSelectionData(document.getElementById("route_departure_rep"),c,b);fillVfrWaypointSelectionData(document.getElementById("route_destination_rep"),b,c);$("#route_departure_rep").selectmenu("refresh");
$("#route_destination_rep").selectmenu("refresh");updatePlanActivationMethods(document.getElementById("planActivationMethod"),c);$("#planActivationMethod").selectmenu("refresh");createFlyingTimeTable();a.value==UNOFFICIAL_AERODROME_INDEX?$("#zzzz_departure_container").slideDown():$("#zzzz_departure_container").slideUp()}
function onChangeDestinationAd(){var a=document.getElementById("departure"),b=document.getElementById("destination");$("#destination").selectmenu("refresh");var c=getAerodromeByIndex(b.value);document.getElementById("route_destination_ad").innerHTML=c.icao+" ("+c.name+")";a=getAerodromeByIndex(a.value);c=getAerodromeByIndex(b.value);fillVfrWaypointSelectionData(document.getElementById("route_departure_rep"),a,c);fillVfrWaypointSelectionData(document.getElementById("route_destination_rep"),c,a);$("#route_departure_rep").selectmenu("refresh");
$("#route_destination_rep").selectmenu("refresh");updatePlanActivationMethods(document.getElementById("planCompletionMethod"),c);$("#planCompletionMethod").selectmenu("refresh");createFlyingTimeTable();b.value==UNOFFICIAL_AERODROME_INDEX?$("#zzzz_destination_container").slideDown():$("#zzzz_destination_container").slideUp()}function getTimeFromDistance(a,b){return 0<b?Math.round(60*(a/b)):"Tarkista lentonopeus!"}function timeNext5mins(a){return a=5*Math.ceil(a/5)}
function convertFlyingTimeToString(a){var b=a%60;a=(a-b)/60;var c="";10>a&&(c+="0");c+=a;10>b&&(c+="0");return c+b}function getDistanceInCurrentUnit(a){var b=document.getElementById("aircraftSpeedUnit").value;switch(b){case "K":return Number(a);case "N":return 1E3*Number(a)/1852;default:debug_log("Error: getDistanceInCurrentUnit() - unknown aircraftSpeedUnit: "+b)}return"unknown"}
function createFlyingTimeTable(){updateAircraftIdentificationToMainpage();var a=document.getElementById("aircraftSpeedUnit").value,b=document.getElementById("aircraftSpeed").value,c="";switch(a){case "K":b=Number(b);c="km";break;case "N":b=1852*Number(b)/1E3;c="NM";break;default:debug_log("Error: createFlyingTimeTable() - unknown aircraftSpeedUnit: "+a),b=Number(b)}if(0==b)document.getElementById("flyingTime").innerHTML='<a href="#page-plan-settings" class="ui-btn-right">T\u00e4yt\u00e4 Perustiedot sivulle puuttuvat tiedot!</a>';
else{var d=document.getElementById("departure").value,e=document.getElementById("route_departure_rep").value,f=document.getElementById("route_destination_rep").value,g=document.getElementById("destination").value,a=[];a.push(getAerodromeByIndex(d));a.push(getVfrWayPointByName(e));a.push(getVfrWayPointByName(f));a.push(getAerodromeByIndex(g));e='<table data-role="table" id="flyingTimeTable" class="table-stripe"><thead><tr class="ui-bar-d">';e+='<th data-priority="persist">paikka</th>';e+='<th data-priority="2">'+
c+"</th>";e+='<th data-priority="1">min</th>';e+="</tr></thead><tbody>";d="<tr>"+("<td>"+a[0].icao+" ("+a[0].name+")</td>");d+="<td>0</td><td>0</td>";d+="</tr>";e+=d;d=a[0];f=0;for(g=1;g<a.length;++g)if(null!==a[g])var h=calcDistanceFrom(d.lat,d.lon,a[g].lat,a[g].lon),f=f+h,d="<tr>",d=void 0===a[g].icao?d+("<td>"+a[g].name+"</td>"):d+("<td>"+a[g].icao+" ("+a[g].name+")</td>"),d=d+("<td>"+Math.round(getDistanceInCurrentUnit(h))+"</td>"),d=d+("<td>"+getTimeFromDistance(h,b)+"</td>"),d=d+"</tr>",e=e+
d,d=a[g];d="<tr><th>Yhteens\u00e4</th>";d+="<th>"+Math.round(getDistanceInCurrentUnit(f))+" "+c+"</th>";d+="<th>"+getTimeFromDistance(f,b)+" min</th>";d+="</tr>";e+=d;document.getElementById("flyingTime").innerHTML=e;b=getTimeFromDistance(f,b);b=timeNext5mins(b);10>b&&(b=10);gCalculatedFlyingTimeStr=convertFlyingTimeToString(b);setFlightTimeOverride(!1)}}
function convertScandinavianLetters(a){a=a.replace(/[\u00e4\u00e5]/g,"a");a=a.replace(/[\u00c4\u00c5]/g,"A");a=a.replace(/\u00f6/g,"o");return a=a.replace(/\u00d6/g,"O")}
function updateFlyingTimeValues(){gSelectedFlyingTimeStr=gCalculatedFlyingTimeStr;if(getFlightTimeOverride()){for(var a="",b=document.getElementsByName("flightTimeHour"),c=0;c<b.length;c++)if(!0==b[c].checked){a=b[c].value;break}b=document.getElementsByName("flightTimeMin");for(c=0;c<b.length;c++)if(!0==b[c].checked){a+=b[c].value;break}if(4!==a.length)return alert("Lentoaikaan t\u00e4ytyy antaa sek\u00e4 tunnit ett\u00e4 minuutit!"),!1;if(Number(a)<Number(gSelectedFlyingTimeStr))return alert("Lentoajaksi ei voi antaa v\u00e4hemp\u00e4\u00e4 kuin laskelmassa on laskettu!"),
!1;gSelectedFlyingTimeStr=a}}
function updateFlightPlanLink(){for(var a=document.getElementsByName("departureTimeHour"),b=0,c=0;c<a.length;c++)if(a[c].checked){b=Number(a[c].value);break}for(var d=document.getElementsByName("departureTimeMin"),c=a=0;c<d.length;c++)if(d[c].checked){a=Number(d[c].value);break}if(0===b+a)return alert("L\u00e4ht\u00f6aika ei voi olla heti.\nMuuta l\u00e4ht\u00f6aika j\u00e4rkev\u00e4ksi."),!1;d=new Date;c="";d.setMinutes(timeNext5mins(d.getMinutes())+a);d.setHours(d.getHours()+b);b=d.getUTCHours();
a=d.getUTCMinutes();10>b&&(c+="0");c+=b;10>a&&(c+="0");c+=a;b="&id="+document.getElementById("aircraftIdentification").value;b+="&rules=V&type=G";b+="&aircraft="+document.getElementById("aircraftType").value;b+="&cat=L";b+="&equipment="+document.getElementById("equipment").value;b+="&ssr="+document.getElementById("ssr").value;b+="&ad="+getAerodromeByIndex(document.getElementById("departure").value).icao;b+="&time="+c;b+="&spd="+document.getElementById("aircraftSpeedUnit").value;b+="&speed="+document.getElementById("aircraftSpeed").value;
b+="&lv="+document.getElementById("flight_lv").value;c=document.getElementById("flight_level").value;""==c&&(c=" ");b+="&level="+c;b+="&route=";c="";""!==document.getElementById("route_departure_rep").value&&(c+=document.getElementById("route_departure_rep").value+" ");c+=document.getElementById("route").value;""!==document.getElementById("route_destination_rep").value&&(c+=" "+document.getElementById("route_destination_rep").value);""==c&&(c+=" ");b+=c;b+="&dad="+getAerodromeByIndex(document.getElementById("destination").value).icao;
updateFlyingTimeValues();b+="&eet="+gSelectedFlyingTimeStr;c="";a=document.getElementById("departure").value;a==UNOFFICIAL_AERODROME_INDEX?(c+="DEP%252F"+document.getElementById("zzzz_departure").value+" ",c+=CurrentAerodromeArray[UNOFFICIAL_AERODROME_INDEX].latStr+" ",c+=CurrentAerodromeArray[UNOFFICIAL_AERODROME_INDEX].lonStr+" "):(a=getAerodromeByIndex(a),a.icao==UNOFFICIAL_AERODROME&&(c+="DEP%252F"+a.name+" ",c+=a.latStr+" ",c+=a.lonStr+" "));a=document.getElementById("destination").value;a==
UNOFFICIAL_AERODROME_INDEX?c+="DEST%252F"+document.getElementById("zzzz_destination").value+" ":(a=getAerodromeByIndex(a),a.icao==UNOFFICIAL_AERODROME&&(c+="DEST%252F"+a.name+" ",c+=a.latStr+" ",c+=a.lonStr+" "));isPbnNeeded()&&(a=document.getElementById("equipmentPBN").value,c+="PBN%252F"+a+" ");c+="RMK%252F";"phoneOnGound"==document.getElementById("planActivationMethod").value?c+="DEP "+BY_PHONE_ON_GROUND_STR:"rtfOnAir"==document.getElementById("planActivationMethod").value&&(a=document.getElementById("departure"),
a=getAerodromeByIndex(a.value),c+="DEP "+BY_RTF_ON_AIR_STR+a.acc+" ");"phoneOnGound"==document.getElementById("planCompletionMethod").value?c+="ARR "+BY_PHONE_ON_GROUND_STR:"rtfOnAir"==document.getElementById("planCompletionMethod").value&&(a=document.getElementById("destination"),a=getAerodromeByIndex(a.value),c+="ARR "+BY_RTF_ON_AIR_STR+a.acc+" ");c+="PIC TEL "+document.getElementById("pilotTel").value;b+="&other="+c;a="";d=document.getElementsByName("enduranceHour");for(c=0;c<d.length;c++)if(d[c].checked){a=
d[c].value;break}d=document.getElementsByName("enduranceMin");for(c=0;c<d.length;c++)if(d[c].checked){a+=d[c].value;break}if(0===Number(a))return alert("Toiminta-aika ei voi olla nolla!\nMeinasitko p\u00e4\u00e4st\u00e4 pitk\u00e4lle?"),!1;b+="&endurance="+a;a="";d=document.getElementsByName("persons");for(c=0;c<d.length;c++)if(d[c].checked){a=d[c].value;break}b+="&person="+a;b+="&markings="+document.getElementById("aircraftColor").value;b+="&pic="+document.getElementById("pilot").value;b+="&tel="+
document.getElementById("pilotTel").value;b+="&filed="+document.getElementById("pilot").value;b=convertScandinavianLetters(b);flightPlanLink="http://ais.fi/C/flightplan/efpl_lomake/"+b;return!0}
function getPlanForStoring(){for(var a={},b=document.getElementsByName("departureTimeHour"),c=0,d=0;d<b.length;d++)if(b[d].checked){c=Number(b[d].value);break}for(var e=document.getElementsByName("departureTimeMin"),d=b=0;d<e.length;d++)if(e[d].checked){b=Number(e[d].value);break}if(0===c+b)return alert("L\u00e4ht\u00f6aika ei voi olla heti.\nMuuta l\u00e4ht\u00f6aika j\u00e4rkev\u00e4ksi."),!1;d=new Date;d.setMinutes(timeNext5mins(d.getMinutes())+b);d.setHours(d.getHours()+c);d.getUTCHours();d.getUTCMinutes();
"phoneOnGound"==document.getElementById("planActivationMethod").value?a.activation_method=BY_PHONE_ON_GROUND_STR_WITH_PHONE:"rtfOnAir"==document.getElementById("planActivationMethod").value?(c=document.getElementById("departure"),c=getAerodromeByIndex(c.value),a.activation_method=BY_RTF_ON_AIR_STR+c.acc+" "):a.activation_method=BY_TWR;"phoneOnGound"==document.getElementById("planCompletionMethod").value?a.completion_method=BY_PHONE_ON_GROUND_STR_WITH_PHONE:"rtfOnAir"==document.getElementById("planCompletionMethod").value?
(c=document.getElementById("destination"),c=getAerodromeByIndex(c.value),a.completion_method=BY_RTF_ON_AIR_STR+c.acc+" "):a.completion_method=BY_TWR;a.takeoff_time=d.toJSON();a.identification=document.getElementById("aircraftIdentification").value;a.departure=getAerodromeByIndex(document.getElementById("departure").value).icao;a.dep_name=getAerodromeByIndex(document.getElementById("departure").value).name;a.dep_route=document.getElementById("route_departure_rep").value;d=document.getElementById("route").value;
a.route=$("<p>"+d+"</p>").text();a.dest_route=document.getElementById("route_destination_rep").value;a.destination=getAerodromeByIndex(document.getElementById("destination").value).icao;a.dest_name=getAerodromeByIndex(document.getElementById("destination").value).name;d=document.getElementById("flight_lv").value;"VFR"!==d&&(d+=document.getElementById("flight_level").value);a.flight_level=d;c="";b=document.getElementsByName("enduranceHour");for(d=0;d<b.length;d++)if(b[d].checked){c=b[d].value;break}b=
document.getElementsByName("enduranceMin");for(d=0;d<b.length;d++)if(b[d].checked){c+=b[d].value;break}a.endurance=c;c=document.getElementsByName("persons");for(d=0;d<c.length;d++)if(c[d].checked){a.persons=c[d].value;break}updateFlyingTimeValues();a.flight_time=gSelectedFlyingTimeStr;return a}function storeCurrentPlan(){var a=getPlanForStoring();addPlanToStorage(a);updateStoredPlanList()}
function onClickFlightPlanLinkButton(){if(isAllSettingsAvailable())try{updateFlightPlanLink()&&(storeCurrentPlan(),window.open(flightPlanLink))}catch(a){alert("Lentosuunnitelman luominen ei onnistunut.\n"+a)}else alert("Perustietoja puuttuu viel\u00e4.\nLis\u00e4\u00e4 puuttuvat tiedot Perustiedot sivulle, niin lentosuunnitelma saadaan t\u00e4ytetty\u00e4 oikein."),window.open("#page-plan-settings","_self")}
function getNotamLink(a){if("EFAA"<=a&&"EFLP">=a)return"http://www.ais.fi/ais/bulletins/envfra.htm#"+a;if("EFMA"<=a&&"EFYL">=a)return"http://www.ais.fi/ais/bulletins/envfrm.htm#"+a};